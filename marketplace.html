<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Demo NFT Marketplace</title>
  <!-- Se carga ethers.js desde CDN -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <h1>NFT Marketplace Demo</h1>
  
  <!-- Conectar wallet -->
  <button id="connectButton">Conectar Wallet</button>
  <p id="walletAddress">Wallet no conectada</p>

  <!-- Sección para crear un listado -->
  <h2>Crear Listado (Aprobar NFT + Listar)</h2>
  <p>Completa los siguientes campos para crear un listado:</p>
  <ul>
    <li>
      Dirección de la colección (ERC1155):<br>
      <input id="collectionInput" type="text" placeholder="Collection address" value="0xa92a8F5A47efC77da796dfD0827D07872E7D0429">
    </li>
    <li>
      Token ID:<br>
      <input id="tokenIdInput" type="number" placeholder="Token ID" value="7">
    </li>
    <li>
      Cantidad:<br>
      <input id="quantityInput" type="number" placeholder="Cantidad" value="1">
    </li>
    <li>
      Precio (en $ADRIAN, asumiendo 18 decimales):<br>
      <input id="priceInput" type="text" placeholder="Precio en tokens" value="10">
    </li>
    <li>
      Duración (en segundos):<br>
      <input id="durationInput" type="number" placeholder="Duración en segundos" value="259200">
    </li>
  </ul>
  <button id="createListingButton">Aprobar NFT y Crear Listado</button>

  <!-- Sección para comprar un listado -->
  <h2>Comprar Listado</h2>
  <p>Ingresa el ID del listado:</p>
  <input type="text" id="listingIdInput" placeholder="ID del listado">
  <button id="buyListingButton">Comprar Listado</button>

  <script>
    // ABI mínimo para ERC1155 (solo para aprobación)
    const erc1155Abi = [
      "function setApprovalForAll(address operator, bool approved) external",
      "function isApprovedForAll(address account, address operator) external view returns (bool)"
    ];

    // ABI mínimo para el contrato NFTMarketplace
    const marketplaceAbi = [
      "function createListing(address collection, uint256 tokenId, uint256 quantity, uint256 price, uint256 duration) external",
      "function buyListing(uint256 listingId) external",
      "function listings(uint256 listingId) external view returns (tuple(uint256 id, address seller, address collection, uint256 tokenId, uint256 quantity, uint256 price, uint256 expirationTime))",
      "event ListingCreated(uint256 indexed listingId, address indexed seller, address collection, uint256 tokenId, uint256 quantity, uint256 price, uint256 expirationTime)"
    ];

    // Dirección hardcodeada del contrato NFTMarketplace
    const marketplaceAddress = "0x424a2456cc04724508f2bdb11b572d79da1fa244";

    let provider;
    let signer;
    let walletAddress;
    let marketplaceContract;

    // Función para conectar la wallet (MetaMask)
    async function connectWallet() {
      if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        walletAddress = await signer.getAddress();
        document.getElementById("walletAddress").innerText = "Wallet: " + walletAddress;
        marketplaceContract = new ethers.Contract(marketplaceAddress, marketplaceAbi, signer);
      } else {
        alert("¡Instala MetaMask!");
      }
    }
    document.getElementById("connectButton").addEventListener("click", connectWallet);

    // Función para aprobar el NFT (si no está aprobado) y crear el listado
    async function approveAndCreateListing() {
      if (!marketplaceContract) {
        alert("Conecta tu wallet primero");
        return;
      }
      
      // Obtiene los valores de los inputs
      const collectionAddress = document.getElementById("collectionInput").value;
      const tokenId = document.getElementById("tokenIdInput").value;
      const quantity = document.getElementById("quantityInput").value;
      const priceInput = document.getElementById("priceInput").value;
      const duration = document.getElementById("durationInput").value;
      
      // Convierte el precio a 18 decimales
      const price = ethers.utils.parseUnits(priceInput, 18);
      
      // Inicializa el contrato ERC1155 de la colección indicada
      const nftContract = new ethers.Contract(collectionAddress, erc1155Abi, signer);
      
      try {
        // Verifica si el NFT ya está aprobado para el marketplace
        const approved = await nftContract.isApprovedForAll(walletAddress, marketplaceAddress);
        if (!approved) {
          const approveTx = await nftContract.setApprovalForAll(marketplaceAddress, true);
          await approveTx.wait();
          alert("NFT aprobado para el marketplace");
        }
        
        // Crea el listado en el marketplace
        const tx = await marketplaceContract.createListing(collectionAddress, tokenId, quantity, price, duration);
        const receipt = await tx.wait();
        // Busca el evento ListingCreated para obtener el ID del listado
        const event = receipt.events.find(event => event.event === "ListingCreated");
        if (event) {
          const listingId = event.args.listingId.toString();
          alert("Listado creado con ID: " + listingId);
        } else {
          alert("Listado creado, pero no se pudo obtener el ID");
        }
      } catch (error) {
        console.error(error);
        alert("Error en el proceso: " + error.message);
      }
    }
    document.getElementById("createListingButton").addEventListener("click", approveAndCreateListing);

    // Función para comprar un listado, aprobando primero la cantidad de tokens $ADRIAN necesaria
    async function buyListing() {
      if (!signer) {
        await connectWallet();
      }
      if (!marketplaceContract) {
        alert("Conecta tu wallet primero");
        return;
      }
      const listingId = document.getElementById("listingIdInput").value;
      if (!listingId) {
        alert("Ingresa el ID del listado");
        return;
      }
      
      // Obtiene el listado para conocer el precio
      let listing;
      try {
        listing = await marketplaceContract.listings(listingId);
        if (listing.seller === "0x0000000000000000000000000000000000000000") {
          alert("El listado no existe o ya fue vendido/cancelado");
          return;
        }
      } catch (err) {
        console.error("Error al leer el listado:", err);
        alert("Error al leer el listado");
        return;
      }
      
      const requiredAmount = listing.price;
      
      // Instancia el contrato ERC20 para $ADRIAN (la dirección está hardcodeada en el contrato)
      const tokenAddress = "0x7E99075Ce287F1cF8cBCAaa6A1C7894e404fD7Ea";
      const erc20Abi = [
          "function allowance(address owner, address spender) view returns (uint256)",
          "function approve(address spender, uint256 amount) returns (bool)"
      ];
      const tokenContract = new ethers.Contract(tokenAddress, erc20Abi, signer);
      
      try {
        const currentAllowance = await tokenContract.allowance(walletAddress, marketplaceAddress);
        if (currentAllowance.lt(requiredAmount)) {
          const approveTx = await tokenContract.approve(marketplaceAddress, requiredAmount);
          await approveTx.wait();
          alert("Token $ADRIAN aprobado para la cantidad requerida");
        }
      } catch (err) {
        console.error("Error en la aprobación de tokens:", err);
        alert("Error al aprobar tokens: " + err.message);
        return;
      }
      
      try {
        const tx = await marketplaceContract.buyListing(listingId);
        await tx.wait();
        alert("Listado comprado exitosamente");
      } catch (error) {
        console.error(error);
        alert("Error al comprar listado: " + error.message);
      }
    }
    document.getElementById("buyListingButton").addEventListener("click", buyListing);
  </script>
</body>
</html>
