<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Demo NFT Marketplace</title>
  <!-- Se carga ethers.js desde CDN -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <h1>NFT Marketplace Demo</h1>

  <!-- Sección para conectar la wallet -->
  <button id="connectButton">Conectar Wallet</button>
  <p id="walletAddress">Wallet no conectada</p>

  <!-- Sección para crear un listado -->
  <h2>Crear Listado (Aprobar NFT + Listar)</h2>
  <p>Completa los campos para crear un listado:</p>
  <ul>
    <li>
      Dirección de la colección (ERC1155):
      <input id="collectionInput" type="text" placeholder="Collection address" value="0xa92a8F5A47efC77da796dfD0827D07872E7D0429">
    </li>
    <li>
      Token ID:
      <input id="tokenIdInput" type="number" placeholder="Token ID" value="7">
    </li>
    <li>
      Cantidad:
      <input id="quantityInput" type="number" placeholder="Cantidad" value="1">
    </li>
    <li>
      Precio (en $ADRIAN, asumiendo 18 decimales):
      <input id="priceInput" type="text" placeholder="Precio en tokens" value="10">
    </li>
    <li>
      Duración (en segundos):
      <input id="durationInput" type="number" placeholder="Duración en segundos" value="259200">
    </li>
    <li>
      Dirección del Marketplace:
      <input id="marketplaceInput" type="text" placeholder="Marketplace address or ENS" value="0x45c7D235c97E4Cb78fbaCe020e674EB97ba1De5d">
    </li>
  </ul>
  <button id="createListingButton">Aprobar NFT y Crear Listado</button>

  <!-- Sección para comprar un listado -->
  <h2>Comprar Listado</h2>
  <input type="text" id="listingIdInput" placeholder="ID del listado">
  <button id="buyListingButton">Comprar Listado</button>

  <script>
    // ABI mínimo para ERC1155 (setApprovalForAll e isApprovedForAll)
    const erc1155Abi = [
      "function setApprovalForAll(address operator, bool approved) external",
      "function isApprovedForAll(address account, address operator) external view returns (bool)"
    ];

    // ABI mínimo para el NFTMarketplace (createListing y buyListing)
    const marketplaceAbi = [
      "function createListing(address collection, uint256 tokenId, uint256 quantity, uint256 price, uint256 duration) external",
      "function buyListing(uint256 listingId) external",
      "function listings(uint256 listingId) external view returns (tuple(uint256 id, address seller, address collection, uint256 tokenId, uint256 quantity, uint256 price, uint256 expirationTime))",
      "event ListingCreated(uint256 indexed listingId, address indexed seller, address collection, uint256 tokenId, uint256 quantity, uint256 price, uint256 expirationTime)"
    ];

    let provider;
    let signer;
    let walletAddress;
    let marketplaceContract;

    // Función auxiliar para resolver ENS si es necesario
    async function resolveAddress(addressOrEns) {
      try {
        if (ethers.utils.isAddress(addressOrEns)) {
          return addressOrEns;
        } else {
          const resolved = await provider.resolveName(addressOrEns);
          return resolved || addressOrEns;
        }
      } catch (err) {
        console.error("Error al resolver dirección:", err);
        return addressOrEns;
      }
    }

    // Función para conectar la wallet (MetaMask)
    async function connectWallet() {
      if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        walletAddress = await signer.getAddress();
        document.getElementById("walletAddress").innerText = "Wallet: " + walletAddress;
        // Resolver automáticamente la dirección del marketplace
        const marketplaceInput = document.getElementById("marketplaceInput").value;
        const resolvedMarketplaceAddress = await resolveAddress(marketplaceInput);
        marketplaceContract = new ethers.Contract(resolvedMarketplaceAddress, marketplaceAbi, signer);
      } else {
        alert("¡Instala MetaMask!");
      }
    }
    document.getElementById("connectButton").addEventListener("click", connectWallet);

    // Función para aprobar el NFT (si no está aprobado) y luego crear el listado
    async function approveAndCreateListing() {
      if (!marketplaceContract) {
        alert("Conecta tu wallet primero");
        return;
      }
      
      // Recupera valores de los inputs
      const collectionAddress = document.getElementById("collectionInput").value;
      const tokenId = document.getElementById("tokenIdInput").value;
      const quantity = document.getElementById("quantityInput").value;
      const priceInput = document.getElementById("priceInput").value;
      const duration = document.getElementById("durationInput").value;
      
      // Convierte el precio a la unidad correspondiente (asumiendo 18 decimales)
      const price = ethers.utils.parseUnits(priceInput, 18);
      
      // Inicializa el contrato ERC1155 para la colección indicada
      const nftContract = new ethers.Contract(collectionAddress, erc1155Abi, signer);
      
      try {
        // Verifica si el NFT ya está aprobado para el marketplace
        const approved = await nftContract.isApprovedForAll(walletAddress, marketplaceContract.address);
        if (!approved) {
          // Si no está aprobado, se envía la transacción de aprobación
          const approveTx = await nftContract.setApprovalForAll(marketplaceContract.address, true);
          await approveTx.wait();
          alert("NFT aprobado para el marketplace");
        }
        
        // Una vez aprobado, se crea el listado
        const tx = await marketplaceContract.createListing(
          collectionAddress,
          tokenId,
          quantity,
          price,
          duration
        );
        const receipt = await tx.wait();
        // Busca el evento ListingCreated para obtener el ID del listado
        const event = receipt.events.find(event => event.event === "ListingCreated");
        if (event) {
          const listingId = event.args.listingId.toString();
          alert("Listado creado con ID: " + listingId);
        } else {
          alert("Listado creado, pero no se pudo obtener el ID");
        }
      } catch (error) {
        console.error(error);
        alert("Error en el proceso: " + error.message);
      }
    }
    document.getElementById("createListingButton").addEventListener("click", approveAndCreateListing);

    // Función para comprar un listado, incluyendo la aprobación automática de tokens $ADRIAN
    async function buyListing() {
      // Si no hay signer, se solicita conectar la wallet
      if (!signer) {
        await connectWallet();
      }
      if (!marketplaceContract) {
        alert("Conecta tu wallet primero");
        return;
      }
      const listingId = document.getElementById("listingIdInput").value;
      if (!listingId) {
        alert("Ingresa el ID del listado");
        return;
      }
      
      // Obtenemos los datos del listado para conocer el precio
      let listing;
      try {
        listing = await marketplaceContract.listings(listingId);
        if (listing.seller === "0x0000000000000000000000000000000000000000") {
          alert("El listado no existe o ya fue vendido/cancelado");
          return;
        }
      } catch (err) {
        console.error("Error al leer el listado:", err);
        alert("Error al leer el listado");
        return;
      }
      
      const requiredAmount = listing.price; // Monto en tokens requerido

      // Creamos la instancia del contrato ERC20 para $ADRIAN
      const tokenAddress = "0x7E99075Ce287F1cF8cBCAaa6A1C7894e404fD7Ea";
      const erc20Abi = [
          "function allowance(address owner, address spender) view returns (uint256)",
          "function approve(address spender, uint256 amount) returns (bool)"
      ];
      const tokenContract = new ethers.Contract(tokenAddress, erc20Abi, signer);
      
      try {
        const currentAllowance = await tokenContract.allowance(walletAddress, marketplaceContract.address);
        if (currentAllowance.lt(requiredAmount)) {
          // Si el allowance es insuficiente, aprobamos una cantidad máxima
          const approveTx = await tokenContract.approve(marketplaceContract.address, ethers.constants.MaxUint256);
          await approveTx.wait();
          alert("Token $ADRIAN aprobado para el marketplace");
        }
      } catch (err) {
        console.error("Error en la aprobación de tokens:", err);
        alert("Error al aprobar tokens: " + err.message);
        return;
      }
      
      // Procedemos a comprar el listado
      try {
        const tx = await marketplaceContract.buyListing(listingId);
        await tx.wait();
        alert("Listado comprado exitosamente");
      } catch (error) {
        console.error(error);
        alert("Error al comprar listado: " + error.message);
      }
    }
    document.getElementById("buyListingButton").addEventListener("click", buyListing);
  </script>
</body>
</html>
