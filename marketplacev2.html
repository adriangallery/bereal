<script>
  async function loadNFTs() {
    try {
      const galleryDiv = document.getElementById("nftGallery");
      galleryDiv.innerHTML = "";
      document.getElementById("loadingSpinner").style.display = "block";
      const nextEventId = await nftContract.nextEventId();
      const totalEvents = nextEventId.toNumber();
      
      // Recorremos todos los tokenId (desde 1 hasta totalEvents - 1)
      for (let tokenId = 1; tokenId < totalEvents; tokenId++) {
        let tokenURI = await nftContract.uri(tokenId);
        if (tokenURI.startsWith("ipfs://")) {
          tokenURI = tokenURI.replace("ipfs://", "https://ipfs.io/ipfs/");
        }
        const metadata = await getMetadata(tokenURI);
        let imageUrl = metadata.image || "https://via.placeholder.com/300?text=No+Image";
        if (imageUrl.startsWith("ipfs://")) {
          imageUrl = imageUrl.replace("ipfs://", "https://ipfs.io/ipfs/");
        }
        // Ejemplo: tokenId 13 se muestra con imagen especÃ­fica
        if (tokenId === 13) {
          imageUrl = "https://i2.seadn.io/base/0x62eb92b403cd5d6e9b20b51f27b96552cd9f8bcd/1e469402d7a09eeeac7caf7651b6ad/321e469402d7a09eeeac7caf7651b6ad.webp?w=1000";
        }
        let tokenName = metadata.name || `Token ${tokenId}`;
        if (tokenName.trim() === "#0006 THE BURNED FORTUNE") continue;
        
        // Obtenemos la cantidad que posee el usuario (puede ser 0)
        const balance = await nftContract.balanceOf(userAccount, tokenId);
        const ownedCount = balance.toNumber();
        
        // Obtenemos la cantidad total minteada para este token desde el contrato
        let mintedCount = 0;
        try {
          mintedCount = (await nftContract.totalSupply(tokenId)).toNumber();
        } catch (e) {
          console.error("totalSupply no disponible para tokenId", tokenId, e);
          mintedCount = 0;
        }
        
        // Crear el HTML para la ficha del NFT
        let colDiv = document.createElement("div");
        colDiv.className = "col-6 col-md-3 mb-4";
        let cardHTML = `
          <div class="card nft-card h-100" onclick="showMetadata(${tokenId})">
            <div class="minted-badge">${mintedCount}x</div>
            <img src="${imageUrl}" class="card-img-top" alt="${tokenName}">
            <div class="card-body">
              <h5 class="card-title">${tokenName}</h5>
              <p class="card-text">${ownedCount > 0 ? 'Owned: ' + ownedCount : 'Not owned'}</p>
            </div>
            <button class="see-details-btn" onclick="showMetadata(${tokenId}); event.stopPropagation();">Listings</button>
          </div>
        `;
        colDiv.innerHTML = cardHTML;
        galleryDiv.appendChild(colDiv);
      }
      document.getElementById("loadingSpinner").style.display = "none";
    } catch (error) {
      console.error("Error loading NFTs:", error);
      document.getElementById("nftGallery").innerHTML = "<p>Error loading NFTs.</p>";
      document.getElementById("loadingSpinner").style.display = "none";
    }
  }
</script>
