<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="https://files.catbox.moe/ffvdjy.svg" type="image/svg+xml">
  <meta charset="UTF-8">
  <title>$ADRIAN Marketplace</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: sans-serif;
    }
    .hero {
      background: url('https://emerald-above-tick-265.mypinata.cloud/ipfs/bafybeiabnekmlc67nxf6jboa6ndu7n6k4ci7qfobkcinzu3pmtwe54ovmi') center no-repeat;
      background-size: cover;
      padding: 80px 0;
      text-align: center;
    }
    .section-wrapper {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }
    .list-group-item {
      background-color: #1f1f1f;
      color: #ccc;
      border: 1px solid #333;
    }
    .btn-primary {
      background-color: #007bff;
      border: none;
    }
  </style>
</head>
<body>

  <!-- Menu (Header) -->
  <div id="menu-placeholder"></div>
  <script>
    fetch('components/menu2.html')
      .then(r => r.text())
      .then(html => { document.getElementById('menu-placeholder').innerHTML = html; })
      .catch(err => console.error('Error loading menu2:', err));
  </script>
  <script src="components/menu2.js"></script>

  <!-- Hero Section -->
  <section class="hero">
    <div class="container">
      <h1 class="mt-3">BE REAL | BE ADRIAN</h1>
    </div>
  </section>

  <div class="section-wrapper">
    <header class="text-center mb-4">
      <h2 id="tokenBalance" class="display-4">Balance: Loading...</h2>
      <p id="accountDisplay" class="mt-2"></p>
    </header>
  </div>

  <!-- NFT Gallery -->
  <div id="nftGallery" class="row section-wrapper"></div>

  <!-- Latest Marketplace Events Section -->
  <div class="section-wrapper">
    <h2 class="text-center">Latest Marketplace Events</h2>
    <ul id="eventList" class="list-group mb-3"></ul>
    <div class="text-center">
      <button id="loadMoreEvents" class="btn btn-primary" style="display: none;">Load More Events</button>
    </div>
  </div>

  <!-- Footer -->
  <div id="footer-placeholder"></div>
  <script>
    fetch('components/footer.html')
      .then(response => response.text())
      .then(html => { document.getElementById('footer-placeholder').innerHTML = html; })
      .catch(error => { console.error('Error loading footer:', error); });
  </script>

  <!-- Blockchain Interaction Scripts -->
  <script>
    const EVENT_LIMIT = 10;
    let allEvents = [];
    let displayedEvents = 0;

    const provider = new ethers.providers.JsonRpcProvider("URL_RPC_AQU√ç"); // üöÄ Replace with your RPC URL
    const marketplaceAddress = "0x424a2456cc04724508f2bdb11b572d79da1fa244"; // Marketplace contract address
    const marketplaceAbi = [
      "event ListingCreated(uint256 indexed listingId, address indexed seller, address collection, uint256 tokenId, uint256 quantity, uint256 price, uint256 expirationTime)",
      "event ListingCancelled(uint256 indexed listingId)",
      "event ListingPurchased(uint256 indexed listingId, address indexed buyer)",
      "event OfferMade(uint256 indexed listingId, address indexed buyer, uint256 offerAmount)",
      "event OfferWithdrawn(uint256 indexed listingId, address indexed buyer)",
      "event OfferAccepted(uint256 indexed listingId, address indexed buyer)"
    ];

    const marketplaceContract = new ethers.Contract(marketplaceAddress, marketplaceAbi, provider);

    async function loadMarketplaceEvents() {
      try {
        const latestBlock = await provider.getBlockNumber();
        const logs = await marketplaceContract.queryFilter("*", latestBlock - 5000, latestBlock);

        allEvents = logs.map(log => ({
          type: log.event,
          args: log.args,
          blockNumber: log.blockNumber
        })).reverse();

        displayNextEvents();
      } catch (error) {
        console.error("Error fetching marketplace events:", error);
      }
    }

    function displayNextEvents() {
      const eventList = document.getElementById("eventList");
      const loadMoreButton = document.getElementById("loadMoreEvents");

      let remaining = allEvents.length - displayedEvents;
      let toShow = Math.min(EVENT_LIMIT, remaining);

      for (let i = displayedEvents; i < displayedEvents + toShow; i++) {
        const event = allEvents[i];
        let listItem = document.createElement("li");
        listItem.className = "list-group-item";
        listItem.innerHTML = formatEvent(event);
        eventList.appendChild(listItem);
      }

      displayedEvents += toShow;

      if (displayedEvents < allEvents.length) {
        loadMoreButton.style.display = "block";
      } else {
        loadMoreButton.style.display = "none";
      }
    }

    function formatEvent(event) {
      switch (event.type) {
        case "ListingCreated":
          return `üìå <strong>New Listing:</strong> ID ${event.args.listingId} - Price: ${ethers.utils.formatUnits(event.args.price, 18)} $ADRIAN`;
        case "ListingCancelled":
          return `‚ùå <strong>Listing Cancelled:</strong> ID ${event.args.listingId}`;
        case "ListingPurchased":
          return `‚úÖ <strong>Purchase Completed:</strong> ID ${event.args.listingId} - Buyer: ${event.args.buyer}`;
        case "OfferMade":
          return `üí∞ <strong>New Offer:</strong> ${ethers.utils.formatUnits(event.args.offerAmount, 18)} $ADRIAN - Buyer: ${event.args.buyer}`;
        case "OfferWithdrawn":
          return `üîÑ <strong>Offer Withdrawn:</strong> ID ${event.args.listingId} - User: ${event.args.buyer}`;
        case "OfferAccepted":
          return `üèÜ <strong>Offer Accepted:</strong> ID ${event.args.listingId} - Buyer: ${event.args.buyer}`;
        default:
          return `üîπ Unknown Event: ${event.type}`;
      }
    }

    document.getElementById("loadMoreEvents").addEventListener("click", displayNextEvents);
    
    loadMarketplaceEvents();
  </script>

  <!-- Bootstrap Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>