<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ADRIAN Lottery Frontend v2</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1, h2 { color: #333; }
    .container { max-width: 800px; margin: auto; }
    .section { margin-bottom: 40px; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
    label { display: block; margin-top: 10px; }
    input, button { padding: 10px; margin-top: 5px; width: 100%; max-width: 400px; }
    button { cursor: pointer; }
    .admin-section { background-color: #f9f9f9; border: 2px solid #f44336; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ADRIAN Lottery</h1>
    
    <!-- User Section -->
    <div class="section" id="user-section">
      <h2>User Dashboard</h2>
      <div>
        <button id="connectWallet">Connect Wallet</button>
      </div>
      <div id="accountDisplay"></div>
      <div>
        <h3>Claim Regular Tickets</h3>
        <label for="numTickets">Number of Regular Tickets:</label>
        <input type="number" id="numTickets" min="1" placeholder="Enter number of tickets" />
        <button id="claimTicketsButton">Claim Regular Tickets</button>
      </div>
      <div>
        <h3>Buy Complementary Tickets</h3>
        <label for="numComplTickets">Number of Complementary Tickets:</label>
        <input type="number" id="numComplTickets" min="1" placeholder="Enter number of complementary tickets" />
        <button id="buyComplTicketsButton">Buy Complementary Tickets</button>
      </div>
      <div>
        <h3>Current Round Info</h3>
        <div id="roundInfo"></div>
      </div>
    </div>
    
    <!-- Admin Section -->
    <div class="section admin-section" id="admin-section">
      <h2>Admin Functions</h2>
      <div>
        <h3>Start New Lottery Round</h3>
        <label for="snapshotId">Snapshot ID:</label>
        <input type="number" id="snapshotId" placeholder="Enter snapshot ID" />
        <label for="newTicketPrice">Regular Ticket Price:</label>
        <input type="number" id="newTicketPrice" placeholder="Enter regular ticket price" />
        <label for="newComplTicketPrice">Complementary Ticket Price:</label>
        <input type="number" id="newComplTicketPrice" placeholder="Enter complementary ticket price" />
        <label for="newFixedPrize">Fixed Prize Amount:</label>
        <input type="number" id="newFixedPrize" placeholder="Enter fixed prize amount" />
        <button id="startRoundButton">Start Lottery Round</button>
      </div>
      <div>
        <h3>Update Regular Ticket Price</h3>
        <label for="updateTicketPriceInput">New Regular Ticket Price:</label>
        <input type="number" id="updateTicketPriceInput" placeholder="Enter new regular ticket price" />
        <button id="updateTicketPriceButton">Update Regular Ticket Price</button>
      </div>
      <div>
        <h3>Update Complementary Ticket Price</h3>
        <label for="updateComplTicketPriceInput">New Complementary Ticket Price:</label>
        <input type="number" id="updateComplTicketPriceInput" placeholder="Enter new complementary ticket price" />
        <button id="updateComplTicketPriceButton">Update Complementary Ticket Price</button>
      </div>
      <div>
        <h3>Update Fixed Prize</h3>
        <label for="updateFixedPrizeInput">New Fixed Prize:</label>
        <input type="number" id="updateFixedPrizeInput" placeholder="Enter new fixed prize amount" />
        <button id="updateFixedPrizeButton">Update Fixed Prize</button>
      </div>
      <div>
        <h3>Draw Winners</h3>
        <button id="drawWinnersButton">Draw Winners</button>
      </div>
      <div>
        <h3>Distribute Prizes</h3>
        <button id="distributePrizesButton">Distribute Prizes</button>
      </div>
    </div>
  </div>
  
  <!-- Include ethers.js (UMD build from ethers v5.7.2) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <script>
    // Global variables
    let provider;
    let signer;
    let userAddress;
    let contract;
    
    // ADRIANlottery contract address and ABI
    const contractAddress = "0xe40deaff899a18c91632728cdaad70f389968641";
    const contractABI = [
      // Functions from the v2.1 contract:
      "function claimTickets(uint256 numTickets) external",
      "function buyComplementaryTickets(uint256 numTickets) external",
      "function startLotteryRound(uint256 snapshotId, uint256 newTicketPrice, uint256 newComplementaryTicketPrice, uint256 newFixedPrize) external",
      "function updateTicketPrice(uint256 newPrice) external",
      "function updateComplementaryTicketPrice(uint256 newPrice) external",
      "function updateFixedPrize(uint256 newFixedPrize) external",
      "function drawWinners() external",
      "function distributePrizes() external",
      "function currentRoundId() view returns (uint256)",
      "function claimDeadline() view returns (uint256)",
      "function drawTime() view returns (uint256)",
      "function ticketPrice() view returns (uint256)",
      "function complementaryTicketPrice() view returns (uint256)",
      "function fixedPrize() view returns (uint256)",
      "function getWinners() view returns (address[])"
    ];
    
    async function connectWallet() {
      if (window.ethereum) {
        try {
          provider = new ethers.providers.Web3Provider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          signer = provider.getSigner();
          userAddress = await signer.getAddress();
          document.getElementById("accountDisplay").innerText = "Connected: " + userAddress;
          contract = new ethers.Contract(contractAddress, contractABI, signer);
          loadRoundInfo();
        } catch (error) {
          console.error("Error connecting wallet:", error);
          alert("Error connecting wallet: " + error.message);
        }
      } else {
        alert("Please install MetaMask!");
      }
    }
    
    async function loadRoundInfo() {
      try {
        const roundId = await contract.currentRoundId();
        const deadline = await contract.claimDeadline();
        const drawTimeVal = await contract.drawTime();
        const price = await contract.ticketPrice();
        const complPrice = await contract.complementaryTicketPrice();
        const fixedPrizeVal = await contract.fixedPrize();
        const infoDiv = document.getElementById("roundInfo");
        infoDiv.innerHTML = `
          <p>Current Round ID: ${roundId}</p>
          <p>Regular Ticket Price: ${price.toString()}</p>
          <p>Complementary Ticket Price: ${complPrice.toString()}</p>
          <p>Fixed Prize: ${fixedPrizeVal.toString()}</p>
          <p>Claim Deadline: ${new Date(deadline.toNumber() * 1000).toLocaleString()}</p>
          <p>Draw Time: ${new Date(drawTimeVal.toNumber() * 1000).toLocaleString()}</p>
        `;
      } catch (err) {
        console.error(err);
      }
    }
    
    document.getElementById("connectWallet").addEventListener("click", connectWallet);
    
    // User: Claim Regular Tickets
    document.getElementById("claimTicketsButton").addEventListener("click", async () => {
      const numTickets = document.getElementById("numTickets").value;
      if (!numTickets || numTickets <= 0) {
        alert("Enter a valid number of regular tickets.");
        return;
      }
      try {
        const tx = await contract.claimTickets(numTickets);
        await tx.wait();
        alert("Regular tickets claimed successfully!");
        loadRoundInfo();
      } catch (err) {
        console.error(err);
        alert("Error claiming regular tickets: " + err.message);
      }
    });
    
    // User: Buy Complementary Tickets
    document.getElementById("buyComplTicketsButton").addEventListener("click", async () => {
      const numComplTickets = document.getElementById("numComplTickets").value;
      if (!numComplTickets || numComplTickets <= 0) {
        alert("Enter a valid number of complementary tickets.");
        return;
      }
      try {
        const tx = await contract.buyComplementaryTickets(numComplTickets);
        await tx.wait();
        alert("Complementary tickets purchased successfully!");
        loadRoundInfo();
      } catch (err) {
        console.error(err);
        alert("Error purchasing complementary tickets: " + err.message);
      }
    });
    
    // Admin: Start New Lottery Round
    document.getElementById("startRoundButton").addEventListener("click", async () => {
      const snapshotId = document.getElementById("snapshotId").value;
      const newTicketPrice = document.getElementById("newTicketPrice").value;
      const newComplTicketPrice = document.getElementById("newComplTicketPrice").value;
      const newFixedPrize = document.getElementById("newFixedPrize").value;
      if (!snapshotId || !newTicketPrice || !newComplTicketPrice || !newFixedPrize) {
        alert("Please enter snapshot ID, ticket prices, and fixed prize.");
        return;
      }
      try {
        const tx = await contract.startLotteryRound(snapshotId, newTicketPrice, newComplTicketPrice, newFixedPrize);
        await tx.wait();
        alert("Lottery round started successfully!");
        loadRoundInfo();
      } catch (err) {
        console.error(err);
        alert("Error starting round: " + err.message);
      }
    });
    
    // Admin: Update Regular Ticket Price
    document.getElementById("updateTicketPriceButton").addEventListener("click", async () => {
      const newPrice = document.getElementById("updateTicketPriceInput").value;
      if (!newPrice) {
        alert("Enter a new regular ticket price.");
        return;
      }
      try {
        const tx = await contract.updateTicketPrice(newPrice);
        await tx.wait();
        alert("Regular ticket price updated successfully!");
        loadRoundInfo();
      } catch (err) {
        console.error(err);
        alert("Error updating regular ticket price: " + err.message);
      }
    });
    
    // Admin: Update Complementary Ticket Price
    document.getElementById("updateComplTicketPriceButton").addEventListener("click", async () => {
      const newPrice = document.getElementById("updateComplTicketPriceInput").value;
      if (!newPrice) {
        alert("Enter a new complementary ticket price.");
        return;
      }
      try {
        const tx = await contract.updateComplementaryTicketPrice(newPrice);
        await tx.wait();
        alert("Complementary ticket price updated successfully!");
        loadRoundInfo();
      } catch (err) {
        console.error(err);
        alert("Error updating complementary ticket price: " + err.message);
      }
    });
    
    // Admin: Update Fixed Prize
    document.getElementById("updateFixedPrizeButton").addEventListener("click", async () => {
      const newFixedPrize = document.getElementById("updateFixedPrizeInput").value;
      if (!newFixedPrize) {
        alert("Enter a new fixed prize.");
        return;
      }
      try {
        const tx = await contract.updateFixedPrize(newFixedPrize);
        await tx.wait();
        alert("Fixed prize updated successfully!");
        loadRoundInfo();
      } catch (err) {
        console.error(err);
        alert("Error updating fixed prize: " + err.message);
      }
    });
    
    // Admin: Draw Winners
    document.getElementById("drawWinnersButton").addEventListener("click", async () => {
      try {
        const tx = await contract.drawWinners();
        await tx.wait();
        alert("Winners drawn successfully!");
      } catch (err) {
        console.error(err);
        alert("Error drawing winners: " + err.message);
      }
    });
    
    // Admin: Distribute Prizes
    document.getElementById("distributePrizesButton").addEventListener("click", async () => {
      try {
        const tx = await contract.distributePrizes();
        await tx.wait();
        alert("Prizes distributed successfully!");
      } catch (err) {
        console.error(err);
        alert("Error distributing prizes: " + err.message);
      }
    });
  </script>
</body>
</html>
