<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Ensure proper scaling on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ADRIAN Lottery v2.2 Frontend</title>
  <!-- Bootstrap CSS for styling -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Load ethers.js (UMD build from ethers v5.7.2) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      background-color: #f7f7f7;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
    }
    .section {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .admin-section {
      border: 2px solid #f44336;
    }
    label {
      margin-top: 10px;
      font-weight: bold;
    }
    .input-group .form-control {
      flex: 1 1 auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">ADRIAN Lottery v2.2</h1>
    
    <!-- Wallet Connection Section -->
    <div class="section text-center mb-4">
      <button id="connectWallet" class="btn btn-primary">Connect Wallet</button>
      <div id="accountDisplay" class="mt-2"></div>
    </div>
    
    <!-- User Functions -->
    <div class="section">
      <h2>User Functions</h2>
      <div class="mb-3">
        <h4>Buy Regular Tickets</h4>
        <label for="numRegularTickets">Number of Regular Tickets:</label>
        <input type="number" id="numRegularTickets" class="form-control" placeholder="Enter quantity" min="1">
        <button id="claimTicketsButton" class="btn btn-success mt-2">Buy Regular Tickets</button>
      </div>
      <div class="mb-3">
        <h4>Buy Complementary Tickets</h4>
        <label for="numComplTickets">Number of Complementary Tickets:</label>
        <input type="number" id="numComplTickets" class="form-control" placeholder="Enter quantity" min="1">
        <button id="buyComplTicketsButton" class="btn btn-success mt-2">Buy Complementary Tickets</button>
      </div>
      <div class="mb-3">
        <h4>Current Round Info</h4>
        <div id="roundInfo"></div>
      </div>
    </div>
    
    <!-- Admin Functions -->
    <div class="section admin-section">
      <h2>Admin Functions</h2>
      <div class="mb-3">
        <h4>Start New Round</h4>
        <label for="snapshotId">Snapshot ID:</label>
        <div class="input-group mb-2">
          <input type="number" id="snapshotId" class="form-control" placeholder="Enter or generate Snapshot ID">
          <button id="generateSnapshotButton" class="btn btn-info">Generate Snapshot</button>
        </div>
        <label for="newTicketPrice">Regular Ticket Price (whole tokens):</label>
        <input type="number" id="newTicketPrice" class="form-control" placeholder="e.g., 100" step="any">
        <label for="newComplTicketPrice">Complementary Ticket Price (whole tokens):</label>
        <input type="number" id="newComplTicketPrice" class="form-control" placeholder="e.g., 50" step="any">
        <label for="newFixedPrize">Fixed Prize Amount (whole tokens):</label>
        <input type="number" id="newFixedPrize" class="form-control" placeholder="e.g., 100000" step="any">
        <button id="startRoundButton" class="btn btn-danger mt-2">Start New Round</button>
      </div>
      <div class="mb-3">
        <h4>Update Regular Ticket Price</h4>
        <label for="updateTicketPriceInput">New Regular Ticket Price (whole tokens):</label>
        <input type="number" id="updateTicketPriceInput" class="form-control" placeholder="New price" step="any">
        <button id="updateTicketPriceButton" class="btn btn-warning mt-2">Update Regular Ticket Price</button>
      </div>
      <div class="mb-3">
        <h4>Update Complementary Ticket Price</h4>
        <label for="updateComplTicketPriceInput">New Complementary Ticket Price (whole tokens):</label>
        <input type="number" id="updateComplTicketPriceInput" class="form-control" placeholder="New price" step="any">
        <button id="updateComplTicketPriceButton" class="btn btn-warning mt-2">Update Complementary Ticket Price</button>
      </div>
      <div class="mb-3">
        <h4>Update Fixed Prize</h4>
        <label for="updateFixedPrizeInput">New Fixed Prize (whole tokens):</label>
        <input type="number" id="updateFixedPrizeInput" class="form-control" placeholder="New fixed prize" step="any">
        <button id="updateFixedPrizeButton" class="btn btn-warning mt-2">Update Fixed Prize</button>
      </div>
      <div class="mb-3">
        <h4>Draw Winners</h4>
        <button id="drawWinnersButton" class="btn btn-secondary">Draw Winners</button>
      </div>
      <div class="mb-3">
        <h4>Distribute Prizes</h4>
        <button id="distributePrizesButton" class="btn btn-secondary">Distribute Prizes</button>
      </div>
      <!-- Debug / Admin Info Section -->
      <div class="mb-3">
        <h4>Debug Info (Connected Wallet)</h4>
        <button id="refreshDebugButton" class="btn btn-secondary">Refresh Debug Info</button>
        <div id="debugInfo" class="mt-2"></div>
      </div>
      <!-- Emergency Pause Controls -->
      <div class="mb-3">
        <h4>Emergency Pause</h4>
        <button id="pauseButton" class="btn btn-dark">Pause Contract</button>
        <button id="unpauseButton" class="btn btn-dark">Unpause Contract</button>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Frontend Script -->
  <script>
    let provider;
    let signer;
    let userAddress;
    let lotteryContract;
    
    // Scaling factor to convert human-readable token amounts (whole tokens) into token units (18 decimals)
    const SCALING = ethers.BigNumber.from("1000000000000000000");
    
    // New Lottery contract address (v2.2 with emergency pause)
    const lotteryAddress = "0xf8756348707e57467a541e5f59e775558de04347";
    const lotteryABI = [
      "function claimTickets(uint256 numTickets) external",
      "function buyComplementaryTickets(uint256 numTickets) external",
      "function startLotteryRound(uint256 snapshotId, uint256 newTicketPrice, uint256 newComplementaryTicketPrice, uint256 newFixedPrize) external",
      "function updateTicketPrice(uint256 newPrice) external",
      "function updateComplementaryTicketPrice(uint256 newPrice) external",
      "function updateFixedPrize(uint256 newFixedPrize) external",
      "function drawWinners() external",
      "function distributePrizes() external",
      "function currentRoundId() view returns (uint256)",
      "function claimDeadline() view returns (uint256)",
      "function drawTime() view returns (uint256)",
      "function ticketPrice() view returns (uint256)",
      "function complementaryTicketPrice() view returns (uint256)",
      "function fixedPrize() view returns (uint256)",
      "function getWinners() view returns (address[])",
      "function pause() external",
      "function unpause() external"
    ];
    
    // ADRIAN token contract address (for token approvals and snapshot)
    const tokenAddress = "0x7E99075Ce287F1cF8cBCAaa6A1C7894e404fD7Ea";
    const erc20ABI = [
      "function approve(address spender, uint256 amount) external returns (bool)",
      "function allowance(address owner, address spender) view returns (uint256)"
    ];
    // Token snapshot ABI
    const tokenSnapshotABI = [
      "function snapshot() external returns (uint256)"
    ];
    
    async function connectWallet() {
      if (window.ethereum) {
        try {
          provider = new ethers.providers.Web3Provider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          signer = provider.getSigner();
          userAddress = await signer.getAddress();
          document.getElementById("accountDisplay").innerText = "Connected: " + userAddress;
          lotteryContract = new ethers.Contract(lotteryAddress, lotteryABI, signer);
          loadRoundInfo();
        } catch (error) {
          console.error("Error connecting wallet:", error);
          alert("Error connecting wallet: " + error.message);
        }
      } else {
        alert("Please install MetaMask!");
      }
    }
    
    async function loadRoundInfo() {
      try {
        const roundId = await lotteryContract.currentRoundId();
        const deadline = await lotteryContract.claimDeadline();
        const drawTimeVal = await lotteryContract.drawTime();
        const price = await lotteryContract.ticketPrice();
        const complPrice = await lotteryContract.complementaryTicketPrice();
        const fixedPrizeVal = await lotteryContract.fixedPrize();
        const infoDiv = document.getElementById("roundInfo");
        infoDiv.innerHTML = `
          <p><strong>Current Round ID:</strong> ${roundId}</p>
          <p><strong>Regular Ticket Price:</strong> ${price.toString()} tokens</p>
          <p><strong>Complementary Ticket Price:</strong> ${complPrice.toString()} tokens</p>
          <p><strong>Fixed Prize:</strong> ${fixedPrizeVal.toString()} tokens</p>
          <p><strong>Claim Deadline:</strong> ${new Date(deadline.toNumber() * 1000).toLocaleString()}</p>
          <p><strong>Draw Time:</strong> ${new Date(drawTimeVal.toNumber() * 1000).toLocaleString()}</p>
        `;
      } catch (err) {
        console.error(err);
      }
    }
    
    document.getElementById("connectWallet").addEventListener("click", connectWallet);
    
    // Helper function to approve tokens if needed
    async function approveTokensIfNeeded(amount) {
      const tokenContract = new ethers.Contract(tokenAddress, erc20ABI, signer);
      const currentAllowance = await tokenContract.allowance(userAddress, lotteryAddress);
      if (currentAllowance.lt(amount)) {
        const tx = await tokenContract.approve(lotteryAddress, amount);
        await tx.wait();
      }
    }
    
    // User: Buy Regular Tickets
    document.getElementById("claimTicketsButton").addEventListener("click", async () => {
      const numTickets = document.getElementById("numRegularTickets").value;
      if (!numTickets || numTickets <= 0) {
        alert("Enter a valid number of regular tickets.");
        return;
      }
      try {
        const price = await lotteryContract.ticketPrice();
        const totalCost = price.mul(numTickets).mul(SCALING);
        await approveTokensIfNeeded(totalCost);
        const tx = await lotteryContract.claimTickets(numTickets);
        await tx.wait();
        alert("Regular tickets purchased successfully!");
        loadRoundInfo();
      } catch (err) {
        console.error(err);
        alert("Error buying regular tickets: " + err.message);
      }
    });
    
    // User: Buy Complementary Tickets
    document.getElementById("buyComplTicketsButton").addEventListener("click", async () => {
      const numComplTickets = document.getElementById("numComplTickets").value;
      if (!numComplTickets || numComplTickets <= 0) {
        alert("Enter a valid number of complementary tickets.");
        return;
      }
      try {
        const complPrice = await lotteryContract.complementaryTicketPrice();
        const totalCost = complPrice.mul(numComplTickets).mul(SCALING);
        await approveTokensIfNeeded(totalCost);
        const tx = await lotteryContract.buyComplementaryTickets(numComplTickets);
        await tx.wait();
        alert("Complementary tickets purchased successfully!");
        loadRoundInfo();
      } catch (err) {
        console.error(err);
        alert("Error buying complementary tickets: " + err.message);
      }
    });
    
    // Admin: Generate Snapshot
    document.getElementById("generateSnapshotButton").addEventListener("click", async () => {
      try {
        const tokenContract = new ethers.Contract(tokenAddress, tokenSnapshotABI, signer);
        const tx = await tokenContract.snapshot();
        await tx.wait();
        // Retrieve the new snapshot id using callStatic
        const snapshotId = await tokenContract.callStatic.snapshot();
        document.getElementById("snapshotId").value = snapshotId.toString();
        alert("Snapshot generated successfully! Snapshot ID: " + snapshotId.toString());
      } catch (err) {
        console.error(err);
        alert("Error generating snapshot automatically. Please enter the Snapshot ID manually.");
      }
    });
    
    // Admin: Start New Round
    document.getElementById("startRoundButton").addEventListener("click", async () => {
      const snapshotId = document.getElementById("snapshotId").value;
      const newTicketPrice = document.getElementById("newTicketPrice").value;
      const newComplTicketPrice = document.getElementById("newComplTicketPrice").value;
      const newFixedPrize = document.getElementById("newFixedPrize").value;
      if (!snapshotId || !newTicketPrice || !newComplTicketPrice || !newFixedPrize) {
        alert("Please enter Snapshot ID, ticket prices, and fixed prize.");
        return;
      }
      try {
        // Check if an active round exists
        const currentRoundId = await lotteryContract.currentRoundId();
        if (currentRoundId.gt(0)) {
          const drawTimeVal = await lotteryContract.drawTime();
          const winners = await lotteryContract.getWinners();
          const currentBlock = await provider.getBlock("latest");
          if (currentBlock.timestamp < drawTimeVal.toNumber() || winners.length === 0) {
            alert("The current round is still active. Please finish it before starting a new round.");
            return;
          }
        }
        const tx = await lotteryContract.startLotteryRound(snapshotId, newTicketPrice, newComplTicketPrice, newFixedPrize);
        await tx.wait();
        alert("Lottery round started successfully! Snapshot ID: " + snapshotId);
        loadRoundInfo();
      } catch (err) {
        console.error(err);
        alert("Error starting round: " + err.message);
      }
    });
    
    // Admin: Update Regular Ticket Price
    document.getElementById("updateTicketPriceButton").addEventListener("click", async () => {
      const newPrice = document.getElementById("updateTicketPriceInput").value;
      if (!newPrice) {
        alert("Enter a new regular ticket price.");
        return;
      }
      try {
        const tx = await lotteryContract.updateTicketPrice(newPrice);
        await tx.wait();
        alert("Regular ticket price updated successfully!");
        loadRoundInfo();
      } catch (err) {
        console.error(err);
        alert("Error updating regular ticket price: " + err.message);
      }
    });
    
    // Admin: Update Complementary Ticket Price
    document.getElementById("updateComplTicketPriceButton").addEventListener("click", async () => {
      const newPrice = document.getElementById("updateComplTicketPriceInput").value;
      if (!newPrice) {
        alert("Enter a new complementary ticket price.");
        return;
      }
      try {
        const tx = await lotteryContract.updateComplementaryTicketPrice(newPrice);
        await tx.wait();
        alert("Complementary ticket price updated successfully!");
        loadRoundInfo();
      } catch (err) {
        console.error(err);
        alert("Error updating complementary ticket price: " + err.message);
      }
    });
    
    // Admin: Update Fixed Prize
    document.getElementById("updateFixedPrizeButton").addEventListener("click", async () => {
      const newFixedPrize = document.getElementById("updateFixedPrizeInput").value;
      if (!newFixedPrize) {
        alert("Enter a new fixed prize.");
        return;
      }
      try {
        const tx = await lotteryContract.updateFixedPrize(newFixedPrize);
        await tx.wait();
        alert("Fixed prize updated successfully!");
        loadRoundInfo();
      } catch (err) {
        console.error(err);
        alert("Error updating fixed prize: " + err.message);
      }
    });
    
    // Admin: Draw Winners
    document.getElementById("drawWinnersButton").addEventListener("click", async () => {
      try {
        const tx = await lotteryContract.drawWinners();
        await tx.wait();
        alert("Winners drawn successfully!");
      } catch (err) {
        console.error(err);
        alert("Error drawing winners: " + err.message);
      }
    });
    
    // Admin: Distribute Prizes
    document.getElementById("distributePrizesButton").addEventListener("click", async () => {
      try {
        const tx = await lotteryContract.distributePrizes();
        await tx.wait();
        alert("Prizes distributed successfully!");
      } catch (err) {
        console.error(err);
        alert("Error distributing prizes: " + err.message);
      }
    });
    
    // Admin: Emergency Pause and Unpause
    document.getElementById("pauseButton").addEventListener("click", async () => {
      try {
        const tx = await lotteryContract.pause();
        await tx.wait();
        alert("Contract paused successfully!");
      } catch (err) {
        console.error(err);
        alert("Error pausing contract: " + err.message);
      }
    });
    
    document.getElementById("unpauseButton").addEventListener("click", async () => {
      try {
        const tx = await lotteryContract.unpause();
        await tx.wait();
        alert("Contract unpaused successfully!");
      } catch (err) {
        console.error(err);
        alert("Error unpausing contract: " + err.message);
      }
    });
    
    // Debug Info: Refresh Debug Info for connected wallet
    document.getElementById("refreshDebugButton").addEventListener("click", async () => {
      try {
        const roundId = await lotteryContract.currentRoundId();
        if (roundId.eq(0)) {
          document.getElementById("debugInfo").innerHTML = "No active round.";
          return;
        }
        const tokenContract = new ethers.Contract(tokenAddress, ["function balanceOfAt(address account, uint256 snapshotId) view returns (uint256)"], signer);
        const snapshotId = await lotteryContract.currentSnapshotId();
        const snapshotBalance = await tokenContract.balanceOfAt(userAddress, snapshotId);
        const price = await lotteryContract.ticketPrice();
        const allowedTickets = snapshotBalance.div(price.mul(SCALING));
        const claimedTickets = await lotteryContract.ticketsPurchased(roundId, userAddress);
        const totalTickets = await lotteryContract.totalTickets();
        document.getElementById("debugInfo").innerHTML = `
          <p><strong>Your Snapshot Balance:</strong> ${ethers.utils.formatUnits(snapshotBalance, 18)} tokens</p>
          <p><strong>Allowed Regular Tickets:</strong> ${allowedTickets.toString()}</p>
          <p><strong>Regular Tickets Claimed:</strong> ${claimedTickets.toString()}</p>
          <p><strong>Total Tickets Claimed (all):</strong> ${totalTickets.toString()}</p>
        `;
      } catch (e) {
        console.error(e);
        document.getElementById("debugInfo").innerText = "Error loading debug info: " + e.message;
      }
    });
  </script>
</body>
</html>
