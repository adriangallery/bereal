<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Ensure proper scaling on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ADRIAN Lottery v2.1</title>
  <!-- Bootstrap CSS for styling -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Load ethers.js (UMD build from ethers v5.7.2) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      background-color: #f7f7f7;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
    }
    .section {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .admin-section {
      border: 2px solid #f44336;
    }
    label {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">ADRIAN Lottery v2.1</h1>
    
    <!-- Wallet Connection Section -->
    <div class="section text-center mb-4">
      <button id="connectWallet" class="btn btn-primary">Connect Wallet</button>
      <div id="accountDisplay" class="mt-2"></div>
    </div>
    
    <!-- User Functions -->
    <div class="section">
      <h2>User Functions</h2>
      <div class="mb-3">
        <h4>Buy Regular Tickets</h4>
        <label for="numRegularTickets">Number of Regular Tickets:</label>
        <input type="number" id="numRegularTickets" class="form-control" placeholder="Enter quantity" min="1">
        <button id="claimTicketsButton" class="btn btn-success mt-2">Buy Regular Tickets</button>
      </div>
      <div class="mb-3">
        <h4>Buy Complementary Tickets</h4>
        <label for="numComplTickets">Number of Complementary Tickets:</label>
        <input type="number" id="numComplTickets" class="form-control" placeholder="Enter quantity" min="1">
        <button id="buyComplTicketsButton" class="btn btn-success mt-2">Buy Complementary Tickets</button>
      </div>
      <div class="mb-3">
        <h4>Current Round Info</h4>
        <div id="roundInfo"></div>
      </div>
    </div>
    
    <!-- Admin Functions -->
    <div class="section admin-section">
      <h2>Admin Functions</h2>
      <!-- Note: Snapshot is now automatic -->
      <div class="mb-3">
        <h4>Start New Round</h4>
        <label for="newTicketPrice">Regular Ticket Price:</label>
        <input type="number" id="newTicketPrice" class="form-control" placeholder="Price in tokens" step="any">
        <label for="newComplTicketPrice">Complementary Ticket Price:</label>
        <input type="number" id="newComplTicketPrice" class="form-control" placeholder="Price in tokens" step="any">
        <label for="newFixedPrize">Fixed Prize Amount:</label>
        <input type="number" id="newFixedPrize" class="form-control" placeholder="Fixed prize in tokens" step="any">
        <button id="startRoundButton" class="btn btn-danger mt-2">Start New Round (Auto Snapshot)</button>
      </div>
      <div class="mb-3">
        <h4>Update Regular Ticket Price</h4>
        <label for="updateTicketPriceInput">New Regular Ticket Price:</label>
        <input type="number" id="updateTicketPriceInput" class="form-control" placeholder="New price" step="any">
        <button id="updateTicketPriceButton" class="btn btn-warning mt-2">Update Regular Ticket Price</button>
      </div>
      <div class="mb-3">
        <h4>Update Complementary Ticket Price</h4>
        <label for="updateComplTicketPriceInput">New Complementary Ticket Price:</label>
        <input type="number" id="updateComplTicketPriceInput" class="form-control" placeholder="New price" step="any">
        <button id="updateComplTicketPriceButton" class="btn btn-warning mt-2">Update Complementary Ticket Price</button>
      </div>
      <div class="mb-3">
        <h4>Update Fixed Prize</h4>
        <label for="updateFixedPrizeInput">New Fixed Prize:</label>
        <input type="number" id="updateFixedPrizeInput" class="form-control" placeholder="New fixed prize" step="any">
        <button id="updateFixedPrizeButton" class="btn btn-warning mt-2">Update Fixed Prize</button>
      </div>
      <div class="mb-3">
        <h4>Draw Winners</h4>
        <button id="drawWinnersButton" class="btn btn-secondary">Draw Winners</button>
      </div>
      <div class="mb-3">
        <h4>Distribute Prizes</h4>
        <button id="distributePrizesButton" class="btn btn-secondary">Distribute Prizes</button>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Frontend Script -->
  <script>
    let provider;
    let signer;
    let userAddress;
    let lotteryContract;
    
    // Lottery contract address (v2.1)
    const lotteryAddress = "0x3fa34475260e59cc5f2b762d75bb42b7f34ef05a";
    const lotteryABI = [
      "function claimTickets(uint256 numTickets) external",
      "function buyComplementaryTickets(uint256 numTickets) external",
      "function startLotteryRound(uint256 snapshotId, uint256 newTicketPrice, uint256 newComplementaryTicketPrice, uint256 newFixedPrize) external",
      "function updateTicketPrice(uint256 newPrice) external",
      "function updateComplementaryTicketPrice(uint256 newPrice) external",
      "function updateFixedPrize(uint256 newFixedPrize) external",
      "function drawWinners() external",
      "function distributePrizes() external",
      "function currentRoundId() view returns (uint256)",
      "function claimDeadline() view returns (uint256)",
      "function drawTime() view returns (uint256)",
      "function ticketPrice() view returns (uint256)",
      "function complementaryTicketPrice() view returns (uint256)",
      "function fixedPrize() view returns (uint256)",
      "function getWinners() view returns (address[])"
    ];
    
    // ADRIAN token contract address (for snapshot)
    const tokenAddress = "0x7E99075Ce287F1cF8cBCAaa6A1C7894e404fD7Ea";
    const tokenABI = [
      "function snapshot() external returns (uint256)"
    ];
    
    async function connectWallet() {
      if (window.ethereum) {
        try {
          provider = new ethers.providers.Web3Provider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          signer = provider.getSigner();
          userAddress = await signer.getAddress();
          document.getElementById("accountDisplay").innerText = "Connected: " + userAddress;
          lotteryContract = new ethers.Contract(lotteryAddress, lotteryABI, signer);
          loadRoundInfo();
        } catch (error) {
          console.error("Error connecting wallet:", error);
          alert("Error connecting wallet: " + error.message);
        }
      } else {
        alert("Please install MetaMask!");
      }
    }
    
    async function loadRoundInfo() {
      try {
        const roundId = await lotteryContract.currentRoundId();
        const deadline = await lotteryContract.claimDeadline();
        const drawTimeVal = await lotteryContract.drawTime();
        const price = await lotteryContract.ticketPrice();
        const complPrice = await lotteryContract.complementaryTicketPrice();
        const fixedPrizeVal = await lotteryContract.fixedPrize();
        const infoDiv = document.getElementById("roundInfo");
        infoDiv.innerHTML = `
          <p><strong>Current Round ID:</strong> ${roundId}</p>
          <p><strong>Regular Ticket Price:</strong> ${price.toString()}</p>
          <p><strong>Complementary Ticket Price:</strong> ${complPrice.toString()}</p>
          <p><strong>Fixed Prize:</strong> ${fixedPrizeVal.toString()}</p>
          <p><strong>Claim Deadline:</strong> ${new Date(deadline.toNumber() * 1000).toLocaleString()}</p>
          <p><strong>Draw Time:</strong> ${new Date(drawTimeVal.toNumber() * 1000).toLocaleString()}</p>
        `;
      } catch (err) {
        console.error(err);
      }
    }
    
    document.getElementById("connectWallet").addEventListener("click", connectWallet);
    
    // User: Buy Regular Tickets
    document.getElementById("claimTicketsButton").addEventListener("click", async () => {
      const numTickets = document.getElementById("numRegularTickets").value;
      if (!numTickets || numTickets <= 0) {
        alert("Enter a valid number of regular tickets.");
        return;
      }
      try {
        const tx = await lotteryContract.claimTickets(numTickets);
        await tx.wait();
        alert("Regular tickets purchased successfully!");
        loadRoundInfo();
      } catch (err) {
        console.error(err);
        alert("Error buying regular tickets: " + err.message);
      }
    });
    
    // User: Buy Complementary Tickets
    document.getElementById("buyComplTicketsButton").addEventListener("click", async () => {
      const numComplTickets = document.getElementById("numComplTickets").value;
      if (!numComplTickets || numComplTickets <= 0) {
        alert("Enter a valid number of complementary tickets.");
        return;
      }
      try {
        const tx = await lotteryContract.buyComplementaryTickets(numComplTickets);
        await tx.wait();
        alert("Complementary tickets purchased successfully!");
        loadRoundInfo();
      } catch (err) {
        console.error(err);
        alert("Error buying complementary tickets: " + err.message);
      }
    });
    
    // Admin: Start New Round (Auto Snapshot)
    document.getElementById("startRoundButton").addEventListener("click", async () => {
      const newTicketPrice = document.getElementById("newTicketPrice").value;
      const newComplTicketPrice = document.getElementById("newComplTicketPrice").value;
      const newFixedPrize = document.getElementById("newFixedPrize").value;
      if (!newTicketPrice || !newComplTicketPrice || !newFixedPrize) {
        alert("Please enter ticket prices and fixed prize.");
        return;
      }
      try {
        // Call snapshot() on the ADRIAN token contract
        const tokenContract = new ethers.Contract(tokenAddress, tokenABI, signer);
        const snapshotTx = await tokenContract.snapshot();
        const receipt = await snapshotTx.wait();
        // Extract the snapshot ID from the transaction return (if available)
        // Here we assume the snapshot() function returns a value; if not, use events or a separate call.
        // For simplicity, we perform a call:
        const snapshotId = await tokenContract.callStatic.snapshot();
        console.log("Snapshot ID:", snapshotId.toString());
        
        const tx = await lotteryContract.startLotteryRound(snapshotId, newTicketPrice, newComplTicketPrice, newFixedPrize);
        await tx.wait();
        alert("Lottery round started successfully! Snapshot ID: " + snapshotId.toString());
        loadRoundInfo();
      } catch (err) {
        console.error(err);
        alert("Error starting round: " + err.message);
      }
    });
    
    // Admin: Update Regular Ticket Price
    document.getElementById("updateTicketPriceButton").addEventListener("click", async () => {
      const newPrice = document.getElementById("updateTicketPriceInput").value;
      if (!newPrice) {
        alert("Enter a new regular ticket price.");
        return;
      }
      try {
        const tx = await lotteryContract.updateTicketPrice(newPrice);
        await tx.wait();
        alert("Regular ticket price updated successfully!");
        loadRoundInfo();
      } catch (err) {
        console.error(err);
        alert("Error updating regular ticket price: " + err.message);
      }
    });
    
    // Admin: Update Complementary Ticket Price
    document.getElementById("updateComplTicketPriceButton").addEventListener("click", async () => {
      const newPrice = document.getElementById("updateComplTicketPriceInput").value;
      if (!newPrice) {
        alert("Enter a new complementary ticket price.");
        return;
      }
      try {
        const tx = await lotteryContract.updateComplementaryTicketPrice(newPrice);
        await tx.wait();
        alert("Complementary ticket price updated successfully!");
        loadRoundInfo();
      } catch (err) {
        console.error(err);
        alert("Error updating complementary ticket price: " + err.message);
      }
    });
    
    // Admin: Update Fixed Prize
    document.getElementById("updateFixedPrizeButton").addEventListener("click", async () => {
      const newFixedPrize = document.getElementById("updateFixedPrizeInput").value;
      if (!newFixedPrize) {
        alert("Enter a new fixed prize.");
        return;
      }
      try {
        const tx = await lotteryContract.updateFixedPrize(newFixedPrize);
        await tx.wait();
        alert("Fixed prize updated successfully!");
        loadRoundInfo();
      } catch (err) {
        console.error(err);
        alert("Error updating fixed prize: " + err.message);
      }
    });
    
    // Admin: Draw Winners
    document.getElementById("drawWinnersButton").addEventListener("click", async () => {
      try {
        const tx = await lotteryContract.drawWinners();
        await tx.wait();
        alert("Winners drawn successfully!");
      } catch (err) {
        console.error(err);
        alert("Error drawing winners: " + err.message);
      }
    });
    
    // Admin: Distribute Prizes
    document.getElementById("distributePrizesButton").addEventListener("click", async () => {
      try {
        const tx = await lotteryContract.distributePrizes();
        await tx.wait();
        alert("Prizes distributed successfully!");
      } catch (err) {
        console.error(err);
        alert("Error distributing prizes: " + err.message);
      }
    });
  </script>
</body>
</html>
