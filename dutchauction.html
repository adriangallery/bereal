<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="https://files.catbox.moe/ffvdjy.svg" type="image/svg+xml">
  <meta charset="UTF-8">
  <title>DUTCH Auction</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="application/javascript"></script>
  <style>
    body {
      background-color: #f8f9fa;
    }
    /* Auction Section Style */
    #auctionSection {
      background: #222;
      color: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(255,255,255,0.1);
      margin-bottom: 2rem;
    }
    /* Hero section with the same NFT image */
    .hero {
      background: url('https://emerald-above-tick-265.mypinata.cloud/ipfs/bafybeie5dwecousapfovtqpbtvquhc5lqr6asfmmrimbjph4r2mowbdyua') no-repeat center center;
      background-size: cover;
      padding: 4rem 0;
      color: #fff;
      text-shadow: 0 0 5px #000;
    }
    .hero h1 {
      font-weight: bold;
    }
    /* Auction info styling */
    .auction-info {
      font-size: 2rem;
    }
    .auction-label {
      font-size: 1.5rem;
    }
  </style>
</head>
<body>
  <!-- Menu (Header) -->
  <div id="menu-placeholder"></div>
  <script>
    // Load menu from components/menu2.html if available.
    fetch('components/menu2.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('menu-placeholder').innerHTML = html;
      })
      .catch(error => console.error('Error loading menu:', error));
  </script>
  <script src="components/menu2.js"></script>

  <!-- Hero Section -->
  <section class="hero">
    <div class="container">
      <h1>DUTCH Auction</h1>
      <p>
        The price starts high and decreases over time.<br>
        Buy when you think the price is right!
      </p>
    </div>
  </section>

  <!-- Auction Info Section -->
  <section class="info-section">
    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <div class="info-box">
            <h2>Auction Status</h2>
            <p id="auctionStatus">Loading...</p>
            <p>Current Price: <span id="currentPrice">Loading...</span></p>
            <p>Time Remaining: <span id="timeRemaining">Loading...</span></p>
            <button class="btn btn-primary" onclick="purchase()">Purchase</button>
          </div>
        </div>
        <div class="col-md-6">
          <div class="info-box">
            <h2>Your Balance</h2>
            <p>ADRIAN Balance: <span id="adrianBalance">Loading...</span></p>
            <p>ETH Balance: <span id="ethBalance">Loading...</span></p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <div id="footer-placeholder"></div>
  <script>
    // Load footer from components/footer.html if available.
    fetch('components/footer.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('footer-placeholder').innerHTML = html;
      })
      .catch(error => console.error('Error loading footer:', error));
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Contract address and ABI
    const contractAddress = "0xCE131591a16DADcAc2bBaBE412a5C136dAE217ab";
    const contractABI = [
      "function purchase() public",
      "function getCurrentPrice() public view returns (uint256)",
      "function getTimeRemaining() public view returns (uint256)",
      "function getAuctionStatus() public view returns (string memory)"
    ];

    let contract;
    let provider;
    let signer;
    let userAddress;

    // Initialize ethers
    async function initEthers() {
      if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        contract = new ethers.Contract(contractAddress, contractABI, signer);
        refreshInfo();
      } else {
        alert("Please install MetaMask!");
      }
    }

    // Callback cuando se conecta el wallet vía el menú
    window.onMenuWalletConnected = async function() {
      userAddress = window.menuUserAccount;
      provider = window.menuProvider;
      signer = window.menuSigner;
      contract = new ethers.Contract(contractAddress, contractABI, signer);
      refreshInfo();
    };

    // Callback cuando se desconecta el wallet
    window.onMenuWalletDisconnected = function() {
      userAddress = null;
      provider = null;
      signer = null;
      contract = null;
      document.getElementById("auctionStatus").innerText = "Wallet not connected";
      document.getElementById("currentPrice").innerText = "Loading...";
      document.getElementById("timeRemaining").innerText = "Loading...";
      document.getElementById("adrianBalance").innerText = "Loading...";
      document.getElementById("ethBalance").innerText = "Loading...";
    };

    // Refresh auction information
    async function refreshInfo() {
      if (!contract) return;

      try {
        const [price, timeRemaining, status] = await Promise.all([
          contract.getCurrentPrice(),
          contract.getTimeRemaining(),
          contract.getAuctionStatus()
        ]);

        document.getElementById("currentPrice").innerText = ethers.utils.formatEther(price) + " ADRIAN";
        document.getElementById("timeRemaining").innerText = timeRemaining.toString() + " seconds";
        document.getElementById("auctionStatus").innerText = status;

        // Get balances
        const address = await signer.getAddress();
        const adrianToken = new ethers.Contract(
          "0x7E99075Ce287F1cF8cBCAaa6A1C7894e404fD7Ea",
          ["function balanceOf(address) view returns (uint256)"],
          provider
        );
        const adrianBalance = await adrianToken.balanceOf(address);
        const ethBalance = await provider.getBalance(address);

        document.getElementById("adrianBalance").innerText = ethers.utils.formatEther(adrianBalance) + " ADRIAN";
        document.getElementById("ethBalance").innerText = ethers.utils.formatEther(ethBalance) + " ETH";
      } catch (error) {
        console.error("Error refreshing info:", error);
      }
    }

    // Purchase function
    async function purchase() {
      if (!contract) {
        alert("Please connect your wallet first!");
        return;
      }

      try {
        const tx = await contract.purchase();
        await tx.wait();
        updateStatus("Purchase successful!");
        refreshInfo();
      } catch (error) {
        console.error("Error during purchase:", error);
        if (error.message.includes("arithmetic underflow or overflow")) {
          updateStatus("Error: You don't have enough $ADRIAN tokens to make this purchase. Please check your balance and the current auction price.");
        } else {
          updateStatus("Error during purchase: " + error.message);
        }
      }
    }

    // Update status message
    function updateStatus(message) {
      document.getElementById("auctionStatus").innerText = message;
    }

    // Initialize when the page loads
    window.onload = initEthers;

    // Refresh info every 10 seconds
    setInterval(refreshInfo, 10000);
  </script>
</body>
</html>
