<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Marketplace Frontend</title>
  <!-- Se incluye ethers.js desde CDN -->
  <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
</head>
<body>
  <button id="connectWallet">Conectar Wallet</button>
  
  <h2>Listados Activos</h2>
  <div id="listings">Cargando listados...</div>
  
  <h2>Ofertas</h2>
  <div id="offers">Cargando ofertas...</div>
  
  <h2>Ventas</h2>
  <div id="sales">Cargando ventas...</div>
  
  <script>
    // Reemplaza esta variable por la dirección de tu contrato desplegado.
    const contractAddress = "0xYourContractAddressHere";
    
    // ABI mínima necesaria para interactuar con las funciones y eventos usados.
    const contractABI = [
      "function listingIdCounter() view returns (uint256)",
      "function listings(uint256) view returns (uint256 id, address seller, address collection, uint256 tokenId, uint256 quantity, uint256 price, uint256 expirationTime)",
      "event ListingCreated(uint256 indexed listingId, address indexed seller, address collection, uint256 tokenId, uint256 quantity, uint256 price, uint256 expirationTime)",
      "event ListingCancelled(uint256 indexed listingId)",
      "event ListingPurchased(uint256 indexed listingId, address indexed buyer)",
      "event OfferMade(uint256 indexed listingId, address indexed buyer, uint256 offerAmount)",
      "event OfferWithdrawn(uint256 indexed listingId, address indexed buyer)",
      "event OfferAccepted(uint256 indexed listingId, address indexed buyer)"
    ];
    
    let provider;
    let signer;
    let contract;
    
    // Función para inicializar la conexión con MetaMask y el contrato
    async function init() {
      if (typeof window.ethereum !== 'undefined') {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        contract = new ethers.Contract(contractAddress, contractABI, signer);
        
        loadListings();
        loadOffers();
        loadSales();
      } else {
        alert("Por favor, instala MetaMask");
      }
    }
    
    // Función para cargar y mostrar los listados activos
    async function loadListings() {
      const listingsDiv = document.getElementById("listings");
      listingsDiv.innerHTML = "Cargando listados...";
      try {
        const listingCount = await contract.listingIdCounter();
        const currentBlock = await provider.getBlock("latest");
        const currentTime = currentBlock.timestamp;
        listingsDiv.innerHTML = "";
        // Se recorre desde 1 hasta el contador de listados
        for (let i = 1; i <= listingCount; i++) {
          try {
            const listing = await contract.listings(i);
            // Se valida que el listado exista y que no haya expirado
            if (listing.seller !== "0x0000000000000000000000000000000000000000" && currentTime <= listing.expirationTime) {
              const listingElement = document.createElement("div");
              listingElement.innerHTML = `
                <p><strong>ID:</strong> ${listing.id.toString()}</p>
                <p><strong>Vendedor:</strong> ${listing.seller}</p>
                <p><strong>Colección:</strong> ${listing.collection}</p>
                <p><strong>Token ID:</strong> ${listing.tokenId.toString()}</p>
                <p><strong>Cantidad:</strong> ${listing.quantity.toString()}</p>
                <p><strong>Precio:</strong> ${listing.price.toString()}</p>
                <p><strong>Expira:</strong> ${new Date(listing.expirationTime.toNumber() * 1000).toLocaleString()}</p>
                <hr>
              `;
              listingsDiv.appendChild(listingElement);
            }
          } catch (err) {
            console.error("Error al cargar el listado", i, err);
          }
        }
      } catch (error) {
        console.error("Error al obtener el contador de listados", error);
      }
    }
    
    // Función para cargar y mostrar las ofertas (utilizando el evento OfferMade)
    async function loadOffers() {
      const offersDiv = document.getElementById("offers");
      offersDiv.innerHTML = "Cargando ofertas...";
      try {
        // Se crea el filtro para el evento OfferMade
        const filter = contract.filters.OfferMade();
        const events = await contract.queryFilter(filter);
        // Se agrupan las ofertas por listingId
        const offersMapping = {};
        events.forEach(event => {
          const listingId = event.args.listingId.toString();
          const buyer = event.args.buyer;
          const offerAmount = event.args.offerAmount.toString();
          if (!offersMapping[listingId]) {
            offersMapping[listingId] = [];
          }
          offersMapping[listingId].push({buyer, offerAmount});
        });
        offersDiv.innerHTML = "";
        for (const listingId in offersMapping) {
          const listingOffers = offersMapping[listingId];
          const listingDiv = document.createElement("div");
          listingDiv.innerHTML = `<h3>Listado ID: ${listingId}</h3>`;
          listingOffers.forEach(offer => {
            const offerDiv = document.createElement("div");
            offerDiv.innerHTML = `<p>Comprador: ${offer.buyer} - Oferta: ${offer.offerAmount}</p>`;
            listingDiv.appendChild(offerDiv);
          });
          offersDiv.appendChild(listingDiv);
        }
      } catch (error) {
        console.error("Error al cargar las ofertas", error);
      }
    }
    
    // Función para cargar y mostrar las ventas (consultando eventos ListingPurchased y OfferAccepted)
    async function loadSales() {
      const salesDiv = document.getElementById("sales");
      salesDiv.innerHTML = "Cargando ventas...";
      try {
        const purchasedFilter = contract.filters.ListingPurchased();
        const acceptedFilter = contract.filters.OfferAccepted();
        
        const purchasedEvents = await contract.queryFilter(purchasedFilter);
        const acceptedEvents = await contract.queryFilter(acceptedFilter);
        
        salesDiv.innerHTML = "";
        
        purchasedEvents.forEach(event => {
          const listingId = event.args.listingId.toString();
          const buyer = event.args.buyer;
          const saleDiv = document.createElement("div");
          saleDiv.innerHTML = `<p>Listado ID: ${listingId} comprado por ${buyer}</p>`;
          salesDiv.appendChild(saleDiv);
        });
        
        acceptedEvents.forEach(event => {
          const listingId = event.args.listingId.toString();
          const buyer = event.args.buyer;
          const saleDiv = document.createElement("div");
          saleDiv.innerHTML = `<p>Oferta aceptada en Listado ID: ${listingId} por ${buyer}</p>`;
          salesDiv.appendChild(saleDiv);
        });
      } catch (error) {
        console.error("Error al cargar las ventas", error);
      }
    }
    
    document.getElementById("connectWallet").addEventListener("click", init);
  </script>
</body>
</html>
