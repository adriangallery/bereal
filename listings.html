<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>$ADRIAN Marketplace</title>
  <!-- Load ethers.js from jsDelivr -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1, h2 {
      margin-top: 20px;
    }
    .listing, .offer, .sale {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      display: flex;
      align-items: center;
    }
    .listing img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      margin-right: 15px;
      border-radius: 5px;
    }
    .listing-details {
      flex-grow: 1;
    }
    .listing-details p {
      margin: 4px 0;
    }
    .buy-button {
      background-color: #28a745;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }
    .buy-button:hover {
      background-color: #218838;
    }
  </style>
</head>
<body>
  <h1>$ADRIAN Marketplace</h1>
  <button id="connectWallet">Connect Wallet</button>
  <div id="walletAddress"></div>

  <h2>Active Listings</h2>
  <div id="listings">Loading listings...</div>

  <h2>Offers</h2>
  <div id="offers">Loading offers...</div>

  <h2>Sales</h2>
  <div id="sales">Loading sales...</div>

  <script>
    // Marketplace contract address (provided)
    const contractAddress = "0x424A2456cC04724508f2bDb11B572d79dA1fA244";
    
    // Minimal ABI for the marketplace contract
    const contractABI = [
      "function listingIdCounter() view returns (uint256)",
      "function listings(uint256) view returns (uint256 id, address seller, address collection, uint256 tokenId, uint256 quantity, uint256 price, uint256 expirationTime)",
      "function buyListing(uint256 listingId) external",
      "event ListingCreated(uint256 indexed listingId, address indexed seller, address collection, uint256 tokenId, uint256 quantity, uint256 price, uint256 expirationTime)",
      "event ListingCancelled(uint256 indexed listingId)",
      "event ListingPurchased(uint256 indexed listingId, address indexed buyer)",
      "event OfferMade(uint256 indexed listingId, address indexed buyer, uint256 offerAmount)",
      "event OfferWithdrawn(uint256 indexed listingId, address indexed buyer)",
      "event OfferAccepted(uint256 indexed listingId, address indexed buyer)"
    ];
    
    // Minimal ERC1155 ABI to get token URI from the collection contract
    const erc1155ABI = [
      "function uri(uint256 tokenId) view returns (string)"
    ];
    
    let provider, signer, contract;
    
    // Connect wallet and initialize provider, signer, and contract
    async function connectWallet() {
      if (!window.ethereum) {
        alert("MetaMask is not installed. Please install it to use this app.");
        return;
      }
      provider = new ethers.providers.Web3Provider(window.ethereum);
      try {
        await provider.send("eth_requestAccounts", []);
      } catch (error) {
        console.error("Error connecting wallet:", error);
        return;
      }
      signer = provider.getSigner();
      const userAddress = await signer.getAddress();
      document.getElementById("walletAddress").innerText = "Connected wallet: " + userAddress;
      contract = new ethers.Contract(contractAddress, contractABI, signer);
      
      // Load data from the contract
      loadListings();
      loadOffers();
      loadSales();
    }
    
    document.getElementById("connectWallet").addEventListener("click", connectWallet);
    
    // Helper function to truncate Ethereum addresses (e.g., "0x123...abc")
    function truncateAddress(address) {
      return address.substring(0,6) + "..." + address.substring(address.length - 3);
    }
    
    // Helper function to format prices with commas and two decimals
    function formatPrice(price) {
      // Assume price is stored with 18 decimals
      const formatted = ethers.utils.formatUnits(price, 18);
      const num = parseFloat(formatted);
      return num.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    // Helper function to fetch JSON metadata from a URI
    async function fetchMetadata(uri) {
      if (uri.startsWith("ipfs://")) {
        uri = uri.replace("ipfs://", "https://ipfs.io/ipfs/");
      }
      try {
        const response = await fetch(uri);
        return await response.json();
      } catch (error) {
        console.error("Error fetching metadata from", uri, error);
        return {};
      }
    }
    
    // Load active listings and display them with token metadata
    async function loadListings() {
      const listingsDiv = document.getElementById("listings");
      listingsDiv.innerHTML = "Loading listings...";
      try {
        const listingCount = await contract.listingIdCounter();
        const currentBlock = await provider.getBlock("latest");
        const currentTime = currentBlock.timestamp;
        listingsDiv.innerHTML = "";
        // Iterate through all listings
        for (let i = 1; i <= listingCount; i++) {
          try {
            const listing = await contract.listings(i);
            // Only display if the listing exists and has not expired
            if (listing.seller !== ethers.constants.AddressZero && currentTime <= listing.expirationTime) {
              // Get token metadata from the collection contract
              const collectionContract = new ethers.Contract(listing.collection, erc1155ABI, provider);
              let tokenURI = await collectionContract.uri(listing.tokenId);
              const metadata = await fetchMetadata(tokenURI);
              const image = metadata.image 
                ? (metadata.image.startsWith("ipfs://") 
                   ? metadata.image.replace("ipfs://", "https://ipfs.io/ipfs/") 
                   : metadata.image)
                : "https://via.placeholder.com/80?text=No+Image";
              const tokenName = metadata.name || "Unnamed Token";
              
              // Create a card element for the listing
              const card = document.createElement("div");
              card.className = "listing";
              card.innerHTML = `
                <img src="${image}" alt="${tokenName}">
                <div class="listing-details">
                  <p><strong>Name:</strong> ${tokenName}</p>
                  <p><strong>Price:</strong> ${formatPrice(listing.price)} $ADRIAN</p>
                  <p><strong>Quantity:</strong> ${listing.quantity.toString()}</p>
                  <p><strong>Seller:</strong> ${truncateAddress(listing.seller)}</p>
                </div>
                <button class="buy-button" onclick="buyListing(${listing.id.toString()})">Buy Now</button>
              `;
              listingsDiv.appendChild(card);
            }
          } catch (err) {
            console.error("Error loading listing", i, err);
          }
        }
      } catch (error) {
        console.error("Error fetching listing count", error);
        listingsDiv.innerHTML = "Error loading listings.";
      }
    }
    
    // Function to buy a listing
    async function buyListing(listingId) {
      try {
        const listing = await contract.listings(listingId);
        if (listing.seller === ethers.constants.AddressZero) {
          alert("Listing does not exist or has been cancelled.");
          return;
        }
        // (Add token approval logic here if needed)
        const tx = await contract.buyListing(listingId);
        await tx.wait();
        alert("Listing purchased successfully.");
        // Refresh listings after purchase
        loadListings();
      } catch (error) {
        console.error("Error purchasing listing:", error);
        alert("Error buying listing: " + error.message);
      }
    }
    
    // Load offers using the OfferMade event
    async function loadOffers() {
      const offersDiv = document.getElementById("offers");
      offersDiv.innerHTML = "Loading offers...";
      try {
        const filter = contract.filters.OfferMade();
        const events = await contract.queryFilter(filter);
        const offersMapping = {};
        events.forEach(event => {
          const listingId = event.args.listingId.toString();
          const buyer = event.args.buyer;
          const offerAmount = event.args.offerAmount.toString();
          if (!offersMapping[listingId]) {
            offersMapping[listingId] = [];
          }
          offersMapping[listingId].push({ buyer, offerAmount });
        });
        offersDiv.innerHTML = "";
        for (const listingId in offersMapping) {
          const offerCard = document.createElement("div");
          offerCard.className = "offer";
          offerCard.innerHTML = `<h3>Listing ID: ${listingId}</h3>`;
          offersMapping[listingId].forEach(offer => {
            offerCard.innerHTML += `<p>Buyer: ${offer.buyer} - Offer: ${offer.offerAmount}</p>`;
          });
          offersDiv.appendChild(offerCard);
        }
      } catch (error) {
        console.error("Error loading offers", error);
        offersDiv.innerHTML = "Error loading offers.";
      }
    }
    
    // Load sales using ListingPurchased and OfferAccepted events
    async function loadSales() {
      const salesDiv = document.getElementById("sales");
      salesDiv.innerHTML = "Loading sales...";
      try {
        const purchasedFilter = contract.filters.ListingPurchased();
        const acceptedFilter = contract.filters.OfferAccepted();
        const purchasedEvents = await contract.queryFilter(purchasedFilter);
        const acceptedEvents = await contract.queryFilter(acceptedFilter);
        salesDiv.innerHTML = "";
        purchasedEvents.forEach(event => {
          const listingId = event.args.listingId.toString();
          const buyer = event.args.buyer;
          const saleDiv = document.createElement("div");
          saleDiv.className = "sale";
          saleDiv.innerHTML = `<p>Listing ID: ${listingId} purchased by ${buyer}</p>`;
          salesDiv.appendChild(saleDiv);
        });
        acceptedEvents.forEach(event => {
          const listingId = event.args.listingId.toString();
          const buyer = event.args.buyer;
          const saleDiv = document.createElement("div");
          saleDiv.className = "sale";
          saleDiv.innerHTML = `<p>Offer accepted for Listing ID: ${listingId} by ${buyer}</p>`;
          salesDiv.appendChild(saleDiv);
        });
      } catch (error) {
        console.error("Error loading sales", error);
        salesDiv.innerHTML = "Error loading sales.";
      }
    }
  </script>
</body>
</html>
