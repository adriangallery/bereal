<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Marketplace Frontend</title>
  <!-- Se carga ethers.js desde jsDelivr -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h2 {
      margin-top: 20px;
    }
    .listing, .offer, .sale {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>Marketplace Frontend</h1>
  <button id="connectWallet">Conectar Wallet</button>
  <div id="walletAddress"></div>

  <h2>Listados Activos</h2>
  <div id="listings">Cargando listados...</div>

  <h2>Ofertas</h2>
  <div id="offers">Cargando ofertas...</div>

  <h2>Ventas</h2>
  <div id="sales">Cargando ventas...</div>

  <script>
    // Dirección del contrato (reemplázala por la real)
    const contractAddress = "0x424A2456cC04724508f2bDb11B572d79dA1fA244";
    
    // ABI mínima para interactuar con el contrato
    const contractABI = [
      "function listingIdCounter() view returns (uint256)",
      "function listings(uint256) view returns (uint256 id, address seller, address collection, uint256 tokenId, uint256 quantity, uint256 price, uint256 expirationTime)",
      "event ListingCreated(uint256 indexed listingId, address indexed seller, address collection, uint256 tokenId, uint256 quantity, uint256 price, uint256 expirationTime)",
      "event ListingCancelled(uint256 indexed listingId)",
      "event ListingPurchased(uint256 indexed listingId, address indexed buyer)",
      "event OfferMade(uint256 indexed listingId, address indexed buyer, uint256 offerAmount)",
      "event OfferWithdrawn(uint256 indexed listingId, address indexed buyer)",
      "event OfferAccepted(uint256 indexed listingId, address indexed buyer)"
    ];

    let provider;
    let signer;
    let contract;

    // Función para conectar la wallet y actualizar la interfaz
    async function init() {
      if (!window.ethereum) {
        alert("MetaMask no está instalado. Por favor, instálalo para usar esta aplicación.");
        return;
      }
      provider = new ethers.providers.Web3Provider(window.ethereum);
      try {
        // Solicita acceso a la wallet
        await provider.send("eth_requestAccounts", []);
      } catch (error) {
        console.error("Error al conectar con MetaMask:", error);
        return;
      }
      signer = provider.getSigner();
      const userAddress = await signer.getAddress();
      document.getElementById("walletAddress").innerText = "Wallet conectada: " + userAddress;
      contract = new ethers.Contract(contractAddress, contractABI, signer);
      
      // Cargar datos del contrato
      loadListings();
      loadOffers();
      loadSales();
    }

    // Cargar y mostrar los listados activos
    async function loadListings() {
      const listingsDiv = document.getElementById("listings");
      listingsDiv.innerHTML = "Cargando listados...";
      try {
        const listingCount = await contract.listingIdCounter();
        const currentBlock = await provider.getBlock("latest");
        const currentTime = currentBlock.timestamp;
        listingsDiv.innerHTML = "";
        // Se recorre desde 1 hasta el contador de listados
        for (let i = 1; i <= listingCount; i++) {
          try {
            const listing = await contract.listings(i);
            // Se muestra solo si el listado existe (vendedor distinto de cero) y no ha expirado
            if (listing.seller !== "0x0000000000000000000000000000000000000000" && currentTime <= listing.expirationTime) {
              const listingDiv = document.createElement("div");
              listingDiv.className = "listing";
              listingDiv.innerHTML = `
                <p><strong>ID:</strong> ${listing.id.toString()}</p>
                <p><strong>Vendedor:</strong> ${listing.seller}</p>
                <p><strong>Colección:</strong> ${listing.collection}</p>
                <p><strong>Token ID:</strong> ${listing.tokenId.toString()}</p>
                <p><strong>Cantidad:</strong> ${listing.quantity.toString()}</p>
                <p><strong>Precio:</strong> ${listing.price.toString()}</p>
                <p><strong>Expira:</strong> ${new Date(listing.expirationTime.toNumber() * 1000).toLocaleString()}</p>
              `;
              listingsDiv.appendChild(listingDiv);
            }
          } catch (err) {
            console.error("Error al cargar el listado", i, err);
          }
        }
      } catch (error) {
        console.error("Error al obtener el contador de listados", error);
        listingsDiv.innerHTML = "Error al cargar listados.";
      }
    }

    // Cargar y mostrar las ofertas (consultando eventos OfferMade)
    async function loadOffers() {
      const offersDiv = document.getElementById("offers");
      offersDiv.innerHTML = "Cargando ofertas...";
      try {
        const filter = contract.filters.OfferMade();
        const events = await contract.queryFilter(filter);
        const offersMapping = {};
        events.forEach(event => {
          const listingId = event.args.listingId.toString();
          const buyer = event.args.buyer;
          const offerAmount = event.args.offerAmount.toString();
          if (!offersMapping[listingId]) {
            offersMapping[listingId] = [];
          }
          offersMapping[listingId].push({buyer, offerAmount});
        });
        offersDiv.innerHTML = "";
        for (const listingId in offersMapping) {
          const listingDiv = document.createElement("div");
          listingDiv.className = "offer";
          listingDiv.innerHTML = `<h3>Listado ID: ${listingId}</h3>`;
          offersMapping[listingId].forEach(offer => {
            const offerDiv = document.createElement("div");
            offerDiv.innerHTML = `<p>Comprador: ${offer.buyer} - Oferta: ${offer.offerAmount}</p>`;
            listingDiv.appendChild(offerDiv);
          });
          offersDiv.appendChild(listingDiv);
        }
      } catch (error) {
        console.error("Error al cargar las ofertas", error);
        offersDiv.innerHTML = "Error al cargar ofertas.";
      }
    }

    // Cargar y mostrar las ventas (consultando eventos ListingPurchased y OfferAccepted)
    async function loadSales() {
      const salesDiv = document.getElementById("sales");
      salesDiv.innerHTML = "Cargando ventas...";
      try {
        const purchasedFilter = contract.filters.ListingPurchased();
        const acceptedFilter = contract.filters.OfferAccepted();
        const purchasedEvents = await contract.queryFilter(purchasedFilter);
        const acceptedEvents = await contract.queryFilter(acceptedFilter);
        salesDiv.innerHTML = "";
        purchasedEvents.forEach(event => {
          const listingId = event.args.listingId.toString();
          const buyer = event.args.buyer;
          const saleDiv = document.createElement("div");
          saleDiv.className = "sale";
          saleDiv.innerHTML = `<p>Listado ID: ${listingId} comprado por ${buyer}</p>`;
          salesDiv.appendChild(saleDiv);
        });
        acceptedEvents.forEach(event => {
          const listingId = event.args.listingId.toString();
          const buyer = event.args.buyer;
          const saleDiv = document.createElement("div");
          saleDiv.className = "sale";
          saleDiv.innerHTML = `<p>Oferta aceptada en Listado ID: ${listingId} por ${buyer}</p>`;
          salesDiv.appendChild(saleDiv);
        });
      } catch (error) {
        console.error("Error al cargar las ventas", error);
        salesDiv.innerHTML = "Error al cargar ventas.";
      }
    }

    document.getElementById("connectWallet").addEventListener("click", init);
  </script>
</body>
</html>
