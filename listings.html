<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="https://files.catbox.moe/ffvdjy.svg" type="image/svg+xml">
  <meta charset="UTF-8">
  <title>$ADRIAN Marketplace</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- Custom Styles -->
  <style>
    /* ========== GLOBAL STYLES ========== */
    body {
      background-color: #000;
      color: #fff;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }
    body > * {
      margin: 0;
      padding: 0;
    }
    /* ========== HERO SECTION ========== */
    .hero {
      background: url('https://emerald-above-tick-265.mypinata.cloud/ipfs/bafybeiabnekmlc67nxf6jboa6ndu7n6k4ci7qfobkcinzu3pmtwe54ovmi') center center no-repeat;
      background-size: cover;
      padding: 80px 0;
      text-align: center;
    }
    .hero h1 {
      font-size: 3rem;
      font-weight: bold;
      margin: 0;
    }
    /* ========== SECTION WRAPPER ========== */
    .section-wrapper {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }
    /* ========== MARKETPLACE CARD STYLES ========== */
    .marketplace-card {
      background-color: #1f1f1f;
      border: 1px solid #333;
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.2s ease-in-out;
      cursor: pointer;
      margin-bottom: 20px;
    }
    .marketplace-card:hover {
      transform: scale(1.01);
    }
    .marketplace-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
    .card-body {
      padding: 1rem;
    }
    .card-title {
      color: #eee;
      margin-bottom: 0.5rem;
    }
    .card-text {
      color: #ccc;
      margin-bottom: 0.5rem;
    }
    .buy-button {
      background-color: #28a745;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }
    .buy-button:hover {
      background-color: #218838;
    }
    /* ========== HEADER AND FOOTER PLACEHOLDERS ========== */
    #menu-placeholder, #footer-placeholder {
      width: 100%;
      color: #fff;
    }
    header.text-center.mb-4 {
      margin-top: 2rem;
    }
    /* ========== MODAL STYLES (if needed later) ========== */
    .modal-content {
      background-color: #1c1c1c;
      color: #fff;
    }
    .modal-header, .modal-body {
      border: none;
    }
    .modal-header .btn-close {
      filter: invert(100%);
    }
  </style>
</head>
<body>
  <!-- Menu (Header) -->
  <div id="menu-placeholder"></div>
  <script>
    fetch('components/menu2.html')
      .then(r => r.text())
      .then(html => { document.getElementById('menu-placeholder').innerHTML = html; })
      .catch(err => console.error('Error loading menu2:', err));
  </script>
  <script src="components/menu2.js"></script>

  <!-- Hero Section -->
  <section class="hero">
    <div class="container">
      <h1 class="mt-3">BE REAL | BE ADRIAN</h1>
    </div>
  </section>

  <!-- MAIN CONTENT WRAPPER -->
  <div class="section-wrapper">
    <header class="text-center mb-4">
      <h2 id="tokenBalance" class="display-4">Balance: Loading...</h2>
      <p id="accountDisplay" class="mt-2"></p>
    </header>

    <!-- Marketplace Listings Section -->
    <section>
      <h2 class="text-center mb-4">Marketplace Listings</h2>
      <div id="marketplaceListings" class="row"></div>
    </section>

    <!-- Offers Section -->
    <section>
      <h2 class="text-center mb-4">Offers</h2>
      <div id="offers" class="container"></div>
    </section>

    <!-- Sales Section -->
    <section>
      <h2 class="text-center mb-4">Sales</h2>
      <div id="sales" class="container"></div>
    </section>
  </div>

  <!-- Footer -->
  <div id="footer-placeholder"></div>
  <script>
    fetch('components/footer.html')
      .then(response => response.text())
      .then(html => { document.getElementById('footer-placeholder').innerHTML = html; })
      .catch(error => { console.error('Error loading footer:', error); });
  </script>

  <!-- Scripts and Logic -->
  <script>
    // --- Cache function for metadata ---
    const CACHE_DURATION = 2 * 24 * 60 * 60 * 1000; // 2 days in ms
    async function getMetadata(tokenURI) {
      const cached = localStorage.getItem(tokenURI);
      if (cached) {
        try {
          const parsed = JSON.parse(cached);
          if (Date.now() - parsed.timestamp < CACHE_DURATION) {
            return parsed.data;
          }
        } catch (e) {
          console.error("Error parsing cache for", tokenURI, e);
        }
      }
      try {
        if (tokenURI.startsWith("ipfs://")) {
          tokenURI = tokenURI.replace("ipfs://", "https://ipfs.io/ipfs/");
        }
        const response = await fetch(tokenURI);
        const metadata = await response.json();
        localStorage.setItem(tokenURI, JSON.stringify({ timestamp: Date.now(), data: metadata }));
        return metadata;
      } catch (error) {
        console.error("Error fetching metadata from", tokenURI, error);
        return {};
      }
    }

    // --- Formatters ---
    function formatBalance(balance) {
      const num = parseFloat(balance);
      if (num >= 1e6) return (num / 1e6).toFixed(1).replace(/\.0$/, "") + "M";
      if (num >= 1e3) return (num / 1e3).toFixed(1).replace(/\.0$/, "") + "K";
      return num.toString();
    }
    function formatWithCommasAndDecimals(amount) {
      const numeric = Number(amount);
      return numeric.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function truncateAddress(address) {
      return address.substring(0, 6) + "..." + address.substring(address.length - 3);
    }

    // --- Global Variables and Contract Config ---
    let provider, signer, userAccount;
    const tokenAddress = "0x7E99075Ce287F1cF8cBCAaa6A1C7894e404fD7Ea"; // $ADRIAN token
    const nftCollectionAddress = "0xa92a8F5A47efC77da796dfD0827D07872E7D0429"; // NFT collection contract
    const marketplaceAddress = "0x424a2456cc04724508f2bdb11b572d79da1fa244"; // Marketplace contract
    // ABI for $ADRIAN token (ERC20)
    const tokenABI = [
      "function balanceOf(address account) view returns (uint256)",
      "function allowance(address owner, address spender) view returns (uint256)",
      "function approve(address spender, uint256 amount) returns (bool)"
    ];
    // Minimal ABI for the Marketplace contract
    const marketplaceAbi = [
      "function listingIdCounter() view returns (uint256)",
      "function listings(uint256) external view returns (uint256 id, address seller, address collection, uint256 tokenId, uint256 quantity, uint256 price, uint256 expirationTime)",
      "function buyListing(uint256 listingId) external",
      "event ListingCreated(uint256 indexed listingId, address indexed seller, address collection, uint256 tokenId, uint256 quantity, uint256 price, uint256 expirationTime)",
      "event OfferMade(uint256 indexed listingId, address indexed buyer, uint256 offerAmount)",
      "event OfferAccepted(uint256 indexed listingId, address indexed buyer)",
      "event ListingPurchased(uint256 indexed listingId, address indexed buyer)"
    ];
    // Minimal ABI for ERC1155 to get token URI
    const erc1155Abi = [
      "function uri(uint256 tokenId) view returns (string)"
    ];

    let tokenContract, marketplaceContract;

    // --- This function is called by the menu (menu2.js) when the wallet connects ---
    window.onMenuWalletConnected = async function() {
      provider = window.menuProvider;
      signer = window.menuSigner;
      userAccount = window.menuUserAccount;
      tokenContract = new ethers.Contract(tokenAddress, tokenABI, signer);
      marketplaceContract = new ethers.Contract(marketplaceAddress, marketplaceAbi, signer);
      // Update header info
      updateTokenBalance();
      document.getElementById("accountDisplay").innerText = "Wallet: " + truncateAddress(userAccount);
      // Load marketplace data
      loadMarketplaceListings();
      loadOffers();
      loadSales();
    };

    async function updateTokenBalance() {
      try {
        const balanceRaw = await tokenContract.balanceOf(userAccount);
        const balanceInt = balanceRaw.div(ethers.constants.WeiPerEther).toString();
        document.getElementById("tokenBalance").innerText = `Balance: ${formatBalance(balanceInt)} $ADRIAN`;
      } catch (error) {
        console.error("Error fetching token balance:", error);
        document.getElementById("tokenBalance").innerText = "Balance: Error";
      }
    }

    // --- Load Active Marketplace Listings ---
    async function loadMarketplaceListings() {
      const listingsDiv = document.getElementById("marketplaceListings");
      listingsDiv.innerHTML = "Loading listings...";
      try {
        const counter = await marketplaceContract.listingIdCounter();
        const currentBlock = await provider.getBlock("latest");
        const currentTime = currentBlock.timestamp;
        listingsDiv.innerHTML = "";
        // Iterate through all listing IDs
        for (let i = 1; i <= counter.toNumber(); i++) {
          try {
            const listing = await marketplaceContract.listings(i);
            // Only show active listings: seller != zero and not expired
            if (listing.seller !== ethers.constants.AddressZero && currentTime <= listing.expirationTime) {
              // Instantiate the collection contract to get metadata
              const collectionContract = new ethers.Contract(listing.collection, erc1155Abi, provider);
              let tokenURI = await collectionContract.uri(listing.tokenId);
              const metadata = await getMetadata(tokenURI);
              const image = metadata.image 
                ? (metadata.image.startsWith("ipfs://") 
                    ? metadata.image.replace("ipfs://", "https://ipfs.io/ipfs/") 
                    : metadata.image)
                : "https://via.placeholder.com/300?text=No+Image";
              const tokenName = metadata.name || "Unnamed Token";
              // Calculate price per NFT (assuming price is total for the listing)
              const pricePerNFT = listing.price.div(listing.quantity);
              const formattedPrice = formatWithCommasAndDecimals(ethers.utils.formatUnits(pricePerNFT, 18));
              
              // Create card element using Bootstrap grid classes
              const colDiv = document.createElement("div");
              colDiv.className = "col-12 col-md-4";
              const card = document.createElement("div");
              card.className = "marketplace-card";
              card.innerHTML = `
                <img src="${image}" alt="${tokenName}">
                <div class="card-body">
                  <h5 class="card-title">${tokenName}</h5>
                  <p class="card-text">Price: ${formattedPrice} $ADRIAN</p>
                  <p class="card-text">Quantity: ${listing.quantity.toString()}</p>
                  <p class="card-text">Seller: ${truncateAddress(listing.seller)}</p>
                  <button class="buy-button" onclick="buyListing(${listing.id.toString()})">Buy Now</button>
                </div>
              `;
              colDiv.appendChild(card);
              listingsDiv.appendChild(colDiv);
            }
          } catch (err) {
            console.error("Error loading listing", i, err);
          }
        }
      } catch (error) {
        console.error("Error fetching listings:", error);
        listingsDiv.innerHTML = "Error loading listings.";
      }
    }

    // --- Buy a Listing ---
    async function buyListing(listingId) {
      try {
        const listing = await marketplaceContract.listings(listingId);
        if (listing.seller === ethers.constants.AddressZero) {
          alert("Listing does not exist or has been cancelled.");
          return;
        }
        // (Add token approval logic here if needed)
        const tx = await marketplaceContract.buyListing(listingId);
        await tx.wait();
        alert("Listing purchased successfully.");
        // Refresh listings after purchase
        loadMarketplaceListings();
      } catch (error) {
        console.error("Error purchasing listing:", error);
        alert("Error buying listing: " + error.message);
      }
    }

    // --- Load Offers from OfferMade events ---
    async function loadOffers() {
      const offersDiv = document.getElementById("offers");
      offersDiv.innerHTML = "Loading offers...";
      try {
        const filter = marketplaceContract.filters.OfferMade();
        const events = await marketplaceContract.queryFilter(filter);
        const offersMapping = {};
        events.forEach(event => {
          const listingId = event.args.listingId.toString();
          const buyer = event.args.buyer;
          const offerAmount = event.args.offerAmount.toString();
          if (!offersMapping[listingId]) {
            offersMapping[listingId] = [];
          }
          offersMapping[listingId].push({ buyer, offerAmount });
        });
        offersDiv.innerHTML = "";
        for (const listingId in offersMapping) {
          const offerCard = document.createElement("div");
          offerCard.className = "mb-3";
          offerCard.innerHTML = `<h5>Listing ID: ${listingId}</h5>`;
          offersMapping[listingId].forEach(offer => {
            offerCard.innerHTML += `<p>Buyer: ${offer.buyer} - Offer: ${offer.offerAmount}</p>`;
          });
          offersDiv.appendChild(offerCard);
        }
      } catch (error) {
        console.error("Error loading offers", error);
        offersDiv.innerHTML = "Error loading offers.";
      }
    }

    // --- Load Sales from ListingPurchased and OfferAccepted events ---
    async function loadSales() {
      const salesDiv = document.getElementById("sales");
      salesDiv.innerHTML = "Loading sales...";
      try {
        const purchasedFilter = marketplaceContract.filters.ListingPurchased();
        const acceptedFilter = marketplaceContract.filters.OfferAccepted();
        const purchasedEvents = await marketplaceContract.queryFilter(purchasedFilter);
        const acceptedEvents = await marketplaceContract.queryFilter(acceptedFilter);
        salesDiv.innerHTML = "";
        purchasedEvents.forEach(event => {
          const listingId = event.args.listingId.toString();
          const buyer = event.args.buyer;
          const saleDiv = document.createElement("div");
          saleDiv.className = "mb-2";
          saleDiv.innerHTML = `<p>Listing ID: ${listingId} purchased by ${buyer}</p>`;
          salesDiv.appendChild(saleDiv);
        });
        acceptedEvents.forEach(event => {
          const listingId = event.args.listingId.toString();
          const buyer = event.args.buyer;
          const saleDiv = document.createElement("div");
          saleDiv.className = "mb-2";
          saleDiv.innerHTML = `<p>Offer accepted for Listing ID: ${listingId} by ${buyer}</p>`;
          salesDiv.appendChild(saleDiv);
        });
      } catch (error) {
        console.error("Error loading sales", error);
        salesDiv.innerHTML = "Error loading sales.";
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
