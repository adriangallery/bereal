<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Adrian Gallery Loyalty Dashboard</title>
  <!-- Use a known working UMD build of ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      color: #333;
      margin: 0;
      padding: 0;
    }
    header {
      background: #222;
      color: #fff;
      padding: 1rem;
      text-align: center;
    }
    .container {
      max-width: 960px;
      margin: 2rem auto;
      padding: 1rem;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .section {
      margin-bottom: 2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 0.75rem;
      text-align: left;
    }
    button {
      padding: 0.75rem 1.5rem;
      background: #4caf50;
      color: #fff;
      border: none;
      cursor: pointer;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>Adrian Gallery Loyalty Dashboard</h1>
    <button id="connectWalletButton">Connect Wallet</button>
    <p id="walletAddress"></p>
  </header>

  <div class="container">
    <!-- User Stats Section -->
    <div class="section" id="user-stats">
      <h2>Your Stats</h2>
      <p>Total Points: <span id="totalPoints">0</span></p>
      <p>Highest Claimed Tier: <span id="highestTier">None</span></p>
      <p>Next Claimable Tier: <span id="nextTier">None</span></p>
      <p id="userProgress"></p>
    </div>

    <!-- Tiers Section -->
    <div class="section" id="tiers">
      <h2>Achievement Tiers</h2>
      <div id="tiersTable">Loading tiers...</div>
    </div>

    <!-- Actions Section -->
    <div class="section" id="actions">
      <h2>Claim Your Reward</h2>
      <button id="claimButton">Claim Next Achievement</button>
    </div>
  </div>

  <script>
    // Contract address for LoyaltyAchievements
    const contractAddress = "0xe19212002d335704dcc9f3e90390223e9934ff0c";

    // Minimal ABI for our demo (read functions and claim function)
    const loyaltyABI = [
      {
        "inputs": [
          {"internalType": "address", "name": "user", "type": "address"},
          {"internalType": "uint256", "name": "tierId", "type": "uint256"}
        ],
        "name": "getUserProgress",
        "outputs": [
          {"internalType": "uint256", "name": "currentPoints", "type": "uint256"},
          {"internalType": "uint256", "name": "threshold", "type": "uint256"},
          {"internalType": "uint256", "name": "progressPercentage", "type": "uint256"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "getAllTierIds",
        "outputs": [
          {"internalType": "uint256[]", "name": "", "type": "uint256[]"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "uint256", "name": "tierId", "type": "uint256"}
        ],
        "name": "getTierInfo",
        "outputs": [
          {"internalType": "uint256", "name": "threshold", "type": "uint256"},
          {"internalType": "uint256", "name": "rewardEventId", "type": "uint256"},
          {"internalType": "string", "name": "tierName", "type": "string"},
          {"internalType": "string", "name": "description", "type": "string"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "uint256", "name": "tierId", "type": "uint256"}
        ],
        "name": "claimAchievement",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "address", "name": "", "type": "address"}
        ],
        "name": "points",
        "outputs": [
          {"internalType": "uint256", "name": "", "type": "uint256"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "address", "name": "user", "type": "address"}
        ],
        "name": "getHighestClaimedTier",
        "outputs": [
          {"internalType": "uint256", "name": "highestTierId", "type": "uint256"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "address", "name": "user", "type": "address"}
        ],
        "name": "getNextClaimableTier",
        "outputs": [
          {"internalType": "uint256", "name": "nextTierId", "type": "uint256"},
          {"internalType": "bool", "name": "exists", "type": "bool"}
        ],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    let provider;
    let signer;
    let contract;
    let userAddress;

    // Connect wallet and initialize contract
    async function connectWallet() {
      if (window.ethereum) {
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          userAddress = await signer.getAddress();
          document.getElementById("walletAddress").innerText = "Connected: " + userAddress;
          contract = new ethers.Contract(contractAddress, loyaltyABI, signer);
          loadUserData();
        } catch (error) {
          console.error("Wallet connection error:", error);
          alert("Wallet connection error: " + error.message);
        }
      } else {
        alert("Please install MetaMask!");
      }
    }

    // Load user data from the contract
    async function loadUserData() {
      try {
        // Get total points for the user
        const userPoints = await contract.points(userAddress);
        document.getElementById("totalPoints").innerText = userPoints.toString();

        // Get highest claimed tier
        const highestTier = await contract.getHighestClaimedTier(userAddress);
        document.getElementById("highestTier").innerText = highestTier.toString() === "0" ? "None" : highestTier.toString();

        // Get next claimable tier
        const nextTierData = await contract.getNextClaimableTier(userAddress);
        if (nextTierData.exists) {
          document.getElementById("nextTier").innerText = nextTierData.nextTierId.toString();
          const progressData = await contract.getUserProgress(userAddress, nextTierData.nextTierId);
          document.getElementById("userProgress").innerText = 
            "Progress: " + progressData.progressPercentage.toString() + "% (" +
            progressData.currentPoints.toString() + " / " + progressData.threshold.toString() + ")";
        } else {
          document.getElementById("nextTier").innerText = "None";
          document.getElementById("userProgress").innerText = "";
        }
        loadTiers();
      } catch (error) {
        console.error("Error loading user data:", error);
      }
    }

    // Load all achievement tiers and display them in a table
    async function loadTiers() {
      try {
        const tierIds = await contract.getAllTierIds();
        let tableHtml = `<table>
          <tr>
            <th>Tier ID</th>
            <th>Tier Name</th>
            <th>Threshold</th>
            <th>Description</th>
            <th>Status</th>
          </tr>`;
        for (let i = 0; i < tierIds.length; i++) {
          const tierId = tierIds[i];
          const tierInfo = await contract.getTierInfo(tierId);
          let status = "Locked";
          const nextData = await contract.getNextClaimableTier(userAddress);
          if (nextData.exists && nextData.nextTierId.toString() === tierId.toString()) {
            status = "Claimable";
          }
          const highestClaimed = await contract.getHighestClaimedTier(userAddress);
          if (parseInt(tierId.toString()) <= parseInt(highestClaimed.toString()) && highestClaimed > 0) {
            status = "Claimed";
          }
          tableHtml += `<tr>
            <td>${tierId.toString()}</td>
            <td>${tierInfo.tierName}</td>
            <td>${tierInfo.threshold.toString()}</td>
            <td>${tierInfo.description}</td>
            <td>${status}</td>
          </tr>`;
        }
        tableHtml += `</table>`;
        document.getElementById("tiersTable").innerHTML = tableHtml;
      } catch (error) {
        console.error("Error loading tiers:", error);
      }
    }

    // Claim the next achievement reward
    async function claimAchievement() {
      try {
        const nextData = await contract.getNextClaimableTier(userAddress);
        if (nextData.exists) {
          const tx = await contract.claimAchievement(nextData.nextTierId);
          await tx.wait();
          alert("Achievement claimed for tier: " + nextData.nextTierId.toString());
          loadUserData();
        } else {
          alert("No claimable tier available.");
        }
      } catch (error) {
        console.error("Error claiming achievement:", error);
        alert("Error claiming achievement: " + error.message);
      }
    }

    document.getElementById("connectWalletButton").addEventListener("click", connectWallet);
    document.getElementById("claimButton").addEventListener("click", claimAchievement);
  </script>
</body>
</html>
