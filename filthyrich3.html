<!-- Mint Script -->
<script>
  // Direcciones fijas (asegúrate de que sean las correctas)
  const galleryContractAddress = "0xa92a8F5A47efC77da796dfD0827D07872E7D0429";
  const requiredTokenAddress = "0x7E99075Ce287F1cF8cBCAaa6A1C7894e404fD7Ea";
  const mintEventId = 6;
  
  // ABI para la función mint y el getter mintEvents del contrato ADRIANGALLERY1155
  const galleryABI = [
    "function mint(uint256 eventId, uint256 quantity) external",
    "function mintEvents(uint256) view returns (uint8, uint256, uint256, uint256, uint256, uint256, string, address, bool)"
  ];
  
  // ABI para ERC20 (balanceOf, allowance, approve)
  const erc20ABI = [
    "function balanceOf(address account) view returns (uint256)",
    "function allowance(address owner, address spender) view returns (uint256)",
    "function approve(address spender, uint256 amount) returns (bool)"
  ];
  
  let provider, signer, galleryContract, userAddress;
  
  // Función para cargar información del mint event (precio y tokens minteados)
  async function loadMintInfo() {
    try {
      const mintData = await galleryContract.mintEvents(mintEventId);
      // mintData devuelve: [mintType, price, maxSupply, minted, startTime, endTime, metadataURI, paymentReceiver, burnADRIAN]
      const price = mintData[1];
      const minted = mintData[3];
      document.getElementById("nftCost").innerText = ethers.utils.formatUnits(price, 18);
      document.getElementById("userClaimed").innerText = minted.toString();
    } catch (error) {
      console.error("Error loading mint info:", error);
    }
  }
  
  // Función para actualizar las condiciones (saldo suficiente para mintear)
  async function updateConditions() {
    const conditionsDiv = document.getElementById("conditions");
    conditionsDiv.innerHTML = "";
    try {
      const tokenContract = new ethers.Contract(requiredTokenAddress, erc20ABI, provider);
      const balanceBN = await tokenContract.balanceOf(userAddress);
      // Obtener el precio actual del mint event
      const mintData = await galleryContract.mintEvents(mintEventId);
      const price = mintData[1];
      const quantity = parseInt(document.getElementById("quantity").value);
      const totalCost = price.mul(quantity);
      const userBalance = ethers.BigNumber.from(balanceBN);
      const conditionMet = userBalance.gte(totalCost);
      conditionsDiv.innerHTML += `<p>Tienes suficientes tokens ADRIAN para mintear: ${conditionMet ? "Sí" : "No"} (Tu balance: ${ethers.utils.formatUnits(userBalance, 18)})</p>`;
    } catch (error) {
      console.error("Error checking conditions:", error);
    }
  }
  
  document.getElementById("quantity").addEventListener("input", updateConditions);
  
  document.getElementById("claimBtn").addEventListener("click", async () => {
    const quantity = parseInt(document.getElementById("quantity").value);
    if (quantity <= 0) return;
    document.getElementById("statusMessage").innerText = "Procesando mint...";
    
    try {
      // Consultar el precio actual del mint event
      const mintData = await galleryContract.mintEvents(mintEventId);
      const price = mintData[1];
      const totalCost = price.mul(quantity);
      
      // Instanciar el contrato del token ADRIAN
      const adrianTokenContract = new ethers.Contract(requiredTokenAddress, erc20ABI, signer);
      let allowance = await adrianTokenContract.allowance(userAddress, galleryContractAddress);
      // Si la allowance es insuficiente, reiniciarla a 0 y aprobar el gasto total
      if (allowance.lt(totalCost)) {
        if (allowance.gt(0)) {
          await adrianTokenContract.approve(galleryContractAddress, 0);
        }
        document.getElementById("statusMessage").innerText = "Aprobando tokens ADRIAN...";
        const approveTx = await adrianTokenContract.approve(galleryContractAddress, totalCost);
        await approveTx.wait();
        document.getElementById("statusMessage").innerText = "Aprobación exitosa. Procediendo con mint...";
      }
      
      // Ejecutar la función mint del contrato ADRIANGALLERY1155
      const tx = await galleryContract.mint(mintEventId, quantity);
      await tx.wait();
      document.getElementById("statusMessage").innerText = "Mint exitoso!";
      loadMintInfo();
      updateConditions();
    } catch (error) {
      console.error("Mint failed:", error);
      document.getElementById("statusMessage").innerText = "Mint fallido. Revisa la consola.";
    }
  });
  
  // Callback cuando se conecta la wallet (vía menu2.js)
  window.onMenuWalletConnected = async function() {
    userAddress = window.menuUserAccount;
    provider = window.menuProvider;
    signer = window.menuSigner;
    console.log("Wallet connected: ", userAddress);
    document.getElementById("walletStatus").innerText = "Conectado: " + userAddress;
    document.getElementById("claimInfo").style.display = "block";
    // Instanciar el contrato ADRIANGALLERY1155 usando el signer
    galleryContract = new ethers.Contract(galleryContractAddress, galleryABI, signer);
    loadMintInfo();
    updateConditions();
  };
  
  window.onMenuWalletDisconnected = function() {
    document.getElementById("walletStatus").innerText = "Wallet no conectada. Conéctala vía el menú.";
    document.getElementById("claimInfo").style.display = "none";
  };
</script>
