<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Favicon -->
    <link rel="icon" href="https://files.catbox.moe/ffvdjy.svg" type="image/svg+xml">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AdrianGallery | [游끥 Mint #0000]</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Estilos personalizados -->
    <link href="css/styles.css" rel="stylesheet">
  </head>
  <body>
    <!-- Men칰 -->
    <div id="menu-placeholder"></div>
    <script>
      // Cargar el men칰 desde components/menu.html
      fetch('components/menu.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('menu-placeholder').innerHTML = html;
        })
        .catch(error => {
          console.error('Error al cargar el men칰:', error);
        });
    </script>

    <!-- Header -->
    <header class="text-center">
      <img src="https://adriangallery.com/images/A_5.gif?w=1000" 
           class="img-fluid rounded mx-auto d-block" alt="Header Image">
    </header>

    <!-- Main Content -->
    <main class="container my-4">
      <!-- Aqu칤 va el contenido espec칤fico de cada p치gina -->
      <h1 class="text-center mb-4">AdrianGallery Mint</h1>
  
<!-- Bot칩n para conectar la wallet -->
<div class="text-center mb-3">
  <button id="connectButton" class="btn btn-primary">Connect Wallet</button>
  <div id="walletAddress" class="mt-2"></div>
</div>
  
<hr>
  
<!-- Secci칩n de detalles del NFT -->
<section class="mb-4">
  <h2>NFT Details</h2>
  <div id="eventInfo" class="text-center">
    <img id="nftImage" src="https://ipfs.io/ipfs/bafkreiaadj5yzfpauuhss7733qbrelsfppsi2ca724bled5osichkvgqq4" 
         alt="NFT Preview" style="width:100%; max-width:300px; height:auto; border:1px solid #ccc; margin-bottom:10px;">
    <div class="eventDetails" id="mintDetails">
      <!-- Se cargar치n los detalles del evento de mint -->
    </div>
  </div>
</section>
  
<hr>
  
<!-- Secci칩n para aprobar tokens y realizar el mint en un solo bot칩n -->
<section class="mb-4">
  <h2>Mint NFT</h2>
  <p>Presiona el bot칩n para aprobar tokens y mintear el NFT (cantidades fijas).</p>
  <button id="approveAndMintButton" class="btn btn-success">Aprobar y Mint NFT</button>
</section>
  
<!-- Log de mensajes -->
<div id="log"></div>
  
<!-- Scripts espec칤ficos para esta p치gina -->
<script>
  // Datos de contrato tomados del ejemplo funcional
  const galleryContractAddress = "0x0647992B738Ca71B1fD78336D322e66b40D76710";
  const galleryABI = [
    "function mint(uint256 eventId, uint256 quantity) external",
    "function mintEvents(uint256) public view returns (uint8 mintType, uint256 price, uint256 maxSupply, uint256 minted, uint256 startTime, uint256 endTime, string memory metadataURI)"
  ];
  
  const tokenAddress = "0x7E99075Ce287F1cF8cBCAaa6A1C7894e404fD7Ea";
  const erc20ABI = [
    "function approve(address spender, uint256 amount) external returns (bool)"
  ];
  
  let provider, signer, galleryContract, tokenContract;
  let walletConnected = false;
  const activeEventId = 0;
  const predefinedApprovalAmount = ethers.utils.parseUnits("100", 18);
  const predefinedMintQuantity = 1;
  
  // Elementos del DOM
  const connectButton = document.getElementById("connectButton");
  const walletAddressDiv = document.getElementById("walletAddress");
  const logDiv = document.getElementById("log");
  const nftImage = document.getElementById("nftImage");
  const mintDetailsDiv = document.getElementById("mintDetails");
  const approveAndMintButton = document.getElementById("approveAndMintButton");
  
  function log(message) {
    logDiv.textContent += message + "\n";
  }
  
  // Conectar wallet y cargar detalles del mint event
  connectButton.addEventListener("click", async () => {
    if (window.ethereum) {
      try {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        const address = await signer.getAddress();
        walletAddressDiv.textContent = "Connected: " + address;
        galleryContract = new ethers.Contract(galleryContractAddress, galleryABI, signer);
        tokenContract = new ethers.Contract(tokenAddress, erc20ABI, signer);
        walletConnected = true;
        log("Wallet connected.");
        loadMintEventDetails();
      } catch (error) {
        console.error(error);
        log("Error connecting wallet: " + error.message);
      }
    } else {
      log("No Ethereum provider found. Please install MetaMask.");
    }
  });
  
  // Cargar los detalles del mint event activo
  async function loadMintEventDetails() {
    try {
      const eventData = await galleryContract.mintEvents(activeEventId);
      const price = eventData.price;
      const maxSupply = eventData.maxSupply;
      const minted = eventData.minted;
      const remaining = maxSupply - minted;
      let metadataURI = eventData.metadataURI;
      metadataURI = metadataURI.replace(/^"+|"+$/g, "");
      
      if (maxSupply == 0) {
        mintDetailsDiv.innerHTML = `<p style="color:red;">Mint event not configured. Please contact the owner.</p>`;
        log("Mint event not available.");
        return;
      }
      
      mintDetailsDiv.innerHTML = `
        <p><strong>Price:</strong> ${ethers.utils.formatUnits(price, 18)} ADRIAN tokens</p>
        <p><strong>Max Supply:</strong> ${maxSupply}</p>
        <p><strong>Minted:</strong> ${minted}</p>
        <p><strong>Remaining:</strong> ${remaining}</p>
      `;
      
      if (metadataURI.startsWith("ipfs://")) {
        const cid = metadataURI.replace("ipfs://", "");
        const metadataURL = "https://ipfs.io/ipfs/" + cid;
        fetch(metadataURL)
          .then(response => response.json())
          .then(data => {
            if (data.image) {
              let imageUrl = data.image.replace(/^"+|"+$/g, "");
              if (imageUrl.startsWith("ipfs://")) {
                imageUrl = "https://ipfs.io/ipfs/" + imageUrl.replace("ipfs://", "");
              }
              nftImage.src = imageUrl;
            } else {
              log("No 'image' property found in metadata JSON.");
            }
          })
          .catch(err => {
            console.error("Error fetching metadata:", err);
            log("Error fetching metadata: " + err.message);
          });
      } else {
        nftImage.src = metadataURI;
      }
    } catch (error) {
      console.error("Error loading mint event details:", error);
      log("Error loading mint event details: " + error.message);
    }
  }
  
  // Aprobar tokens y realizar el mint en un solo flujo
  approveAndMintButton.addEventListener("click", async () => {
    if (!walletConnected) {
      log("Please connect your wallet first.");
      return;
    }
    
    try {
      log("Sending approval transaction...");
      const approveTx = await tokenContract.approve(galleryContractAddress, predefinedApprovalAmount);
      log("Approval tx sent: " + approveTx.hash);
      await approveTx.wait();
      log("Tokens approved successfully.");
    } catch (error) {
      console.error("Error during approval:", error);
      log("Error during approval: " + error.message);
      return;
    }
    
    try {
      log("Minting NFT...");
      const mintTx = await galleryContract.mint(activeEventId, predefinedMintQuantity);
      log("Mint tx sent: " + mintTx.hash);
      await mintTx.wait();
      log("NFT minted successfully.");
      loadMintEventDetails();
    } catch (error) {
      console.error("Error during minting:", error);
      log("Error during minting: " + error.message);
    }
  });
</script>
    </main>

    <!-- Footer -->
    <div id="footer-placeholder"></div>
    <script>
      // Cargar el footer desde components/footer.html
      fetch('components/footer.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('footer-placeholder').innerHTML = html;
        })
        .catch(error => {
          console.error('Error al cargar el footer:', error);
        });
    </script>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
