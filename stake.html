<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ADRIAN Staking Dashboard</title>
  <!-- Cargar ethers.js UMD desde CDN -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f4f4f4;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1, h2, h3 {
      color: #333;
    }
    input, button {
      padding: 10px;
      margin: 5px 0;
      font-size: 16px;
    }
    .data p {
      margin: 8px 0;
    }
    #connectButton {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    #connectButton:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ADRIAN Staking Dashboard</h1>
    <button id="connectButton">Conectar Wallet</button>
    <p><strong>Cuenta conectada:</strong> <span id="account"></span></p>
    <div class="data" id="poolData" style="display:none;">
      <h2>Pool ID: <span id="poolId"></span></h2>
      <p><strong>Token de Staking:</strong> <span id="stakingToken"></span></p>
      <p><strong>Token de Recompensa:</strong> <span id="rewardToken"></span></p>
      <p><strong>Reward Rate:</strong> <span id="rewardRate"></span></p>
      <p><strong>Lock Time:</strong> <span id="lockTime"></span> segundos (~3 meses)</p>
      <p><strong>Total Staked:</strong> <span id="totalStaked"></span> tokens</p>
      <p><strong>Balance del Rewards Pool:</strong> <span id="rewardPoolBalance"></span> tokens</p>
      <p><strong>Máximo a Stakear:</strong> <span id="maxStake"></span> tokens</p>
      <p><strong>APY (aprox.):</strong> <span id="apy"></span>%</p>
      <hr>
      <h3>Realizar Stake</h3>
      <input type="text" id="stakeAmount" placeholder="Cantidad a stakear">
      <button id="stakeButton">Stake</button>
    </div>
  </div>

  <script>
    // ABI completa del contrato de staking (según lo proporcionado)
    const contractABI = [
      {
        "inputs": [],
        "stateMutability": "nonpayable",
        "type": "constructor"
      },
      {
        "anonymous": false,
        "inputs": [
          {"indexed": true,"internalType": "address","name": "user","type": "address"},
          {"indexed": true,"internalType": "uint256","name": "poolId","type": "uint256"},
          {"indexed": false,"internalType": "uint256","name": "principal","type": "uint256"},
          {"indexed": false,"internalType": "uint256","name": "depositIndex","type": "uint256"}
        ],
        "name": "EmergencyWithdraw",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {"indexed": true,"internalType": "address","name": "previousOwner","type": "address"},
          {"indexed": true,"internalType": "address","name": "newOwner","type": "address"}
        ],
        "name": "OwnershipTransferred",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {"indexed": false,"internalType": "address","name": "account","type": "address"}
        ],
        "name": "Paused",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {"indexed": true,"internalType": "uint256","name": "poolId","type": "uint256"},
          {"indexed": false,"internalType": "address","name": "stakingToken","type": "address"},
          {"indexed": false,"internalType": "address","name": "rewardToken","type": "address"},
          {"indexed": false,"internalType": "uint256","name": "rewardRate","type": "uint256"},
          {"indexed": false,"internalType": "uint256","name": "lockTime","type": "uint256"},
          {"indexed": false,"internalType": "uint256","name": "initialRewardPool","type": "uint256"}
        ],
        "name": "PoolCreated",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {"indexed": true,"internalType": "uint256","name": "poolId","type": "uint256"},
          {"indexed": false,"internalType": "bool","name": "isActive","type": "bool"}
        ],
        "name": "PoolStatusUpdated",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {"indexed": true,"internalType": "uint256","name": "poolId","type": "uint256"},
          {"indexed": false,"internalType": "uint256","name": "newRewardRate","type": "uint256"},
          {"indexed": false,"internalType": "uint256","name": "newLockTime","type": "uint256"}
        ],
        "name": "PoolUpdated",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {"indexed": true,"internalType": "uint256","name": "poolId","type": "uint256"},
          {"indexed": false,"internalType": "uint256","name": "amount","type": "uint256"}
        ],
        "name": "RewardDeposited",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {"indexed": true,"internalType": "uint256","name": "poolId","type": "uint256"},
          {"indexed": false,"internalType": "uint256","name": "amount","type": "uint256"}
        ],
        "name": "RewardWithdrawn",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {"indexed": true,"internalType": "address","name": "user","type": "address"},
          {"indexed": true,"internalType": "uint256","name": "poolId","type": "uint256"},
          {"indexed": false,"internalType": "uint256","name": "reward","type": "uint256"},
          {"indexed": false,"internalType": "uint256","name": "depositIndex","type": "uint256"}
        ],
        "name": "RewardsClaimed",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {"indexed": true,"internalType": "address","name": "user","type": "address"},
          {"indexed": true,"internalType": "uint256","name": "poolId","type": "uint256"},
          {"indexed": false,"internalType": "uint256","name": "amount","type": "uint256"},
          {"indexed": false,"internalType": "uint256","name": "timestamp","type": "uint256"}
        ],
        "name": "Staked",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {"indexed": false,"internalType": "address","name": "account","type": "address"}
        ],
        "name": "Unpaused",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {"indexed": true,"internalType": "address","name": "user","type": "address"},
          {"indexed": true,"internalType": "uint256","name": "poolId","type": "uint256"},
          {"indexed": false,"internalType": "uint256","name": "principal","type": "uint256"},
          {"indexed": false,"internalType": "uint256","name": "reward","type": "uint256"},
          {"indexed": false,"internalType": "uint256","name": "depositIndex","type": "uint256"}
        ],
        "name": "Withdrawn",
        "type": "event"
      },
      {
        "inputs": [],
        "name": "REWARD_RATE_SCALE",
        "outputs": [
          {"internalType": "uint256","name": "","type": "uint256"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "uint256","name": "poolId","type": "uint256"},
          {"internalType": "address","name": "user","type": "address"},
          {"internalType": "uint256","name": "depositIndex","type": "uint256"}
        ],
        "name": "calculateReward",
        "outputs": [
          {"internalType": "uint256","name": "","type": "uint256"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "uint256","name": "depositIndex","type": "uint256"},
          {"internalType": "uint256","name": "poolId","type": "uint256"}
        ],
        "name": "claimRewards",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "contract IERC20","name": "_stakingToken","type": "address"},
          {"internalType": "contract IERC20","name": "_rewardToken","type": "address"},
          {"internalType": "uint256","name": "_rewardRate","type": "uint256"},
          {"internalType": "uint256","name": "_lockTime","type": "uint256"},
          {"internalType": "uint256","name": "_initialRewardPool","type": "uint256"}
        ],
        "name": "createPool",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "uint256","name": "poolId","type": "uint256"},
          {"internalType": "uint256","name": "amount","type": "uint256"}
        ],
        "name": "depositRewards",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "uint256","name": "poolId","type": "uint256"},
          {"internalType": "uint256","name": "depositIndex","type": "uint256"}
        ],
        "name": "emergencyWithdraw",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "uint256","name": "poolId","type": "uint256"},
          {"internalType": "address","name": "user","type": "address"},
          {"internalType": "uint256","name": "depositIndex","type": "uint256"}
        ],
        "name": "getDepositInfo",
        "outputs": [
          {"internalType": "uint256","name": "amount","type": "uint256"},
          {"internalType": "uint256","name": "startTime","type": "uint256"},
          {"internalType": "uint256","name": "lastClaimTime","type": "uint256"},
          {"internalType": "bool","name": "withdrawn","type": "bool"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "nextPoolId",
        "outputs": [
          {"internalType": "uint256","name": "","type": "uint256"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "owner",
        "outputs": [
          {"internalType": "address","name": "","type": "address"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "pause",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "paused",
        "outputs": [
          {"internalType": "bool","name": "","type": "bool"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "uint256","name": "","type": "uint256"}
        ],
        "name": "pools",
        "outputs": [
          {"internalType": "uint256","name": "poolId","type": "uint256"},
          {"internalType": "contract IERC20","name": "stakingToken","type": "address"},
          {"internalType": "contract IERC20","name": "rewardToken","type": "address"},
          {"internalType": "uint256","name": "rewardRate","type": "uint256"},
          {"internalType": "uint256","name": "lockTime","type": "uint256"},
          {"internalType": "uint256","name": "totalStaked","type": "uint256"},
          {"internalType": "uint256","name": "rewardPoolBalance","type": "uint256"},
          {"internalType": "bool","name": "isActive","type": "bool"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "uint256","name": "poolId","type": "uint256"},
          {"internalType": "bool","name": "_isActive","type": "bool"}
        ],
        "name": "setPoolActive",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "uint256","name": "poolId","type": "uint256"},
          {"internalType": "uint256","name": "amount","type": "uint256"}
        ],
        "name": "stake",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "address","name": "newOwner","type": "address"}
        ],
        "name": "transferOwnership",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "unpause",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "uint256","name": "poolId","type": "uint256"},
          {"internalType": "uint256","name": "_newRewardRate","type": "uint256"},
          {"internalType": "uint256","name": "_newLockTime","type": "uint256"}
        ],
        "name": "updatePool",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "uint256","name": "","type": "uint256"},
          {"internalType": "address","name": "","type": "address"},
          {"internalType": "uint256","name": "","type": "uint256"}
        ],
        "name": "userDeposits",
        "outputs": [
          {"internalType": "uint256","name": "amount","type": "uint256"},
          {"internalType": "uint256","name": "startTime","type": "uint256"},
          {"internalType": "uint256","name": "lastClaimTime","type": "uint256"},
          {"internalType": "bool","name": "withdrawn","type": "bool"}
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "uint256","name": "poolId","type": "uint256"},
          {"internalType": "uint256","name": "depositIndex","type": "uint256"}
        ],
        "name": "withdraw",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "uint256","name": "poolId","type": "uint256"},
          {"internalType": "uint256","name": "amount","type": "uint256"}
        ],
        "name": "withdrawExcessRewards",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];

    // ABI mínima para ERC20 (permitirá consultar allowance y aprobar)
    const erc20ABI = [
      "function allowance(address owner, address spender) view returns (uint256)",
      "function approve(address spender, uint256 amount) returns (bool)"
    ];

    // Dirección del contrato de staking desplegado
    const contractAddress = "0x1AD5Bd04E55BC3283CdDC8f00C74f57E7b057915";
    const poolId = 0;
    const secondsInYear = 31536000;

    let provider, signer, contract;

    async function connectWallet() {
      if (window.ethereum) {
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          contract = new ethers.Contract(contractAddress, contractABI, signer);
          const accounts = await provider.listAccounts();
          document.getElementById("account").innerText = accounts[0];
          document.getElementById("connectButton").style.display = "none";
          document.getElementById("poolData").style.display = "block";
          fetchPoolData();
        } catch (err) {
          console.error("Error al conectar con Metamask:", err);
          alert("Error al conectar con Metamask. Revisa la consola.");
        }
      } else {
        alert("Por favor, instala Metamask.");
      }
    }

    async function fetchPoolData() {
      try {
        const pool = await contract.pools(poolId);
        document.getElementById("poolId").innerText = pool.poolId.toString();
        document.getElementById("stakingToken").innerText = pool.stakingToken;
        document.getElementById("rewardToken").innerText = pool.rewardToken;
        document.getElementById("rewardRate").innerText = pool.rewardRate.toString();
        document.getElementById("lockTime").innerText = pool.lockTime.toString();
        document.getElementById("totalStaked").innerText = ethers.utils.formatEther(pool.totalStaked);
        document.getElementById("rewardPoolBalance").innerText = ethers.utils.formatEther(pool.rewardPoolBalance);
        
        // Máximo a stakear = rewardPoolBalance - totalStaked
        const maxStakeBN = pool.rewardPoolBalance.sub(pool.totalStaked);
        document.getElementById("maxStake").innerText = ethers.utils.formatEther(maxStakeBN);
        
        // APY aproximado = (rewardRate * secondsInYear / 1e18) * 100
        const apy = (Number(pool.rewardRate) * secondsInYear / 1e18 * 100).toFixed(2);
        document.getElementById("apy").innerText = apy;
      } catch (err) {
        console.error("Error al obtener datos del pool:", err);
      }
    }

    async function handleStake() {
      const stakeAmountStr = document.getElementById("stakeAmount").value;
      if (!stakeAmountStr) {
        alert("Por favor, ingresa una cantidad para stakear.");
        return;
      }
      try {
        const amount = ethers.utils.parseEther(stakeAmountStr);
        // Obtiene la dirección del token de staking (ADRIAN) desde los datos del pool
        const tokenAddress = document.getElementById("stakingToken").innerText;
        // Instancia el contrato ERC20 del token
        const erc20Contract = new ethers.Contract(tokenAddress, erc20ABI, signer);
        const currentAccount = document.getElementById("account").innerText;
        // Verifica el allowance actual
        const allowance = await erc20Contract.allowance(currentAccount, contractAddress);
        if (allowance.lt(amount)) {
          alert("Aprobando tokens, por favor espera...");
          const approveTx = await erc20Contract.approve(contractAddress, amount);
          await approveTx.wait();
          alert("Tokens aprobados.");
        }
        const tx = await contract.stake(poolId, amount);
        await tx.wait();
        alert("Stake realizado correctamente.");
        fetchPoolData();
      } catch (err) {
        console.error("Error al realizar el stake:", err);
        alert("Error al realizar el stake. Revisa la consola para más detalles.");
      }
    }

    document.getElementById("connectButton").addEventListener("click", connectWallet);
    document.getElementById("stakeButton").addEventListener("click", handleStake);
  </script>
</body>
</html>
