<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Swap ADRIAN por ETH</title>
  <!-- Incluir ethers.js desde un CDN -->
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; }
    input { padding: 5px; margin-left: 10px; }
    button { padding: 10px 15px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Swap ADRIAN por ETH</h1>
  <button id="connectWalletButton">Conectar Wallet</button>
  <p id="walletStatus"></p>

  <div style="margin-top: 20px;">
    <label for="amountInput">Cantidad de ADRIAN a swapear:</label>
    <input type="number" id="amountInput" placeholder="1000">
  </div>
  
  <div style="margin-top: 20px;">
    <button id="approveButton">Aprobar Token</button>
  </div>
  
  <div style="margin-top: 20px;">
    <button id="swapButton">Ejecutar Swap</button>
  </div>
  
  <p id="statusMessage" style="margin-top: 20px;"></p>

  <script>
    let provider;
    let signer;
    let account;
    let approved = false;

    // --- Direcciones de contratos ---
    const ADRIAN_TOKEN_ADDRESS = "0x7e99075ce287f1cf8cbcaaa6a1c7894e404fd7ea";
    const UNISWAP_ROUTER_ADDRESS = "0x6fF5693b99212Da76ad316178A184AB56D299b43";

    // --- ABI mínima para el token ADRIAN (funciones ERC-20 necesarias) ---
    const ADRIAN_ABI = [
      "function approve(address spender, uint256 amount) public returns (bool)",
      "function decimals() public pure returns (uint8)"
    ];

    // --- ABI mínima para el Router de Uniswap V4 (función execute) ---
    const ROUTER_ABI = [
      "function execute(bytes commands, bytes[] inputs, uint256 deadline) external payable"
    ];

    // Referencias a elementos HTML
    const walletStatusEl = document.getElementById("walletStatus");
    const statusMessageEl = document.getElementById("statusMessage");

    async function connectWallet() {
      if (window.ethereum) {
        try {
          provider = new ethers.providers.Web3Provider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          signer = provider.getSigner();
          account = await signer.getAddress();
          walletStatusEl.innerText = "Wallet conectada: " + account;
          statusMessageEl.innerText = "";
        } catch (error) {
          console.error(error);
          statusMessageEl.innerText = "Error al conectar la wallet";
        }
      } else {
        statusMessageEl.innerText = "Por favor, instala MetaMask";
      }
    }

    async function approveToken() {
      if (!signer) {
        statusMessageEl.innerText = "Conecta la wallet primero";
        return;
      }
      try {
        statusMessageEl.innerText = "Aprobando token...";
        const tokenContract = new ethers.Contract(ADRIAN_TOKEN_ADDRESS, ADRIAN_ABI, signer);
        const decimals = await tokenContract.decimals();
        const amountInput = document.getElementById("amountInput").value;
        const parsedAmount = ethers.utils.parseUnits(amountInput, decimals);
        const tx = await tokenContract.approve(UNISWAP_ROUTER_ADDRESS, parsedAmount);
        await tx.wait();
        statusMessageEl.innerText = "Token aprobado correctamente";
        approved = true;
      } catch (error) {
        console.error(error);
        statusMessageEl.innerText = "Error al aprobar el token";
      }
    }

    async function swapTokens() {
      if (!signer) {
        statusMessageEl.innerText = "Conecta la wallet primero";
        return;
      }
      if (!approved) {
        statusMessageEl.innerText = "Aprueba el token antes de hacer el swap";
        return;
      }
      try {
        statusMessageEl.innerText = "Ejecutando swap...";
        const routerContract = new ethers.Contract(UNISWAP_ROUTER_ADDRESS, ROUTER_ABI, signer);

        // --- Construcción del comando e inputs para el swap ---
        // Se codifica un comando "SWAP" tomando los primeros 4 bytes de la cadena "SWAP"
        const swapCommand = ethers.utils.hexDataSlice(ethers.utils.toUtf8Bytes("SWAP"), 0, 4);

        // Obtener la cantidad de tokens a swapear y sus decimales
        const tokenContract = new ethers.Contract(ADRIAN_TOKEN_ADDRESS, ADRIAN_ABI, signer);
        const decimals = await tokenContract.decimals();
        const amountInput = document.getElementById("amountInput").value;
        const amountIn = ethers.utils.parseUnits(amountInput, decimals);

        // Para este ejemplo se fija el mínimo recibido en 0.
        // En producción debes calcular minAmountOut basado en el precio actual y tu tolerancia al slippage (5.50% en este caso)
        const minAmountOut = 0;

        // Codificar los parámetros del swap en un input:
        // (tokenIn, tokenOut, amountIn, minAmountOut)
        const inputEncoded = ethers.utils.defaultAbiCoder.encode(
          ["address", "address", "uint256", "uint256"],
          [ADRIAN_TOKEN_ADDRESS, ethers.constants.AddressZero, amountIn, minAmountOut]
        );
        const inputs = [inputEncoded];

        // Establecer deadline: 30 minutos a partir de ahora
        const deadline = Math.floor(Date.now() / 1000) + (30 * 60);

        // Ejecutar la transacción de swap (sin enviar ETH adicional en este caso)
        const tx = await routerContract.execute(swapCommand, inputs, deadline, { value: 0 });
        await tx.wait();
        statusMessageEl.innerText = "Swap ejecutado exitosamente!";
      } catch (error) {
        console.error(error);
        statusMessageEl.innerText = "Error al ejecutar el swap";
      }
    }

    // Asignar eventos a los botones
    document.getElementById("connectWalletButton").addEventListener("click", connectWallet);
    document.getElementById("approveButton").addEventListener("click", approveToken);
    document.getElementById("swapButton").addEventListener("click", swapTokens);
  </script>
</body>
</html>
